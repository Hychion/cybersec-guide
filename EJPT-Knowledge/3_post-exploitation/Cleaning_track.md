# 🧹 Suppression des Traces - Cheatsheet Windows & Linux

## 📋 Vue d'ensemble
Cette cheatsheet couvre les techniques de suppression de traces pour Windows et Linux, incluant le nettoyage manuel, les outils spécialisés, et les modules Meterpreter dédiés.

---

# 🪟 PARTIE 1 : WINDOWS

## 🎯 1. Endroits à nettoyer manuellement

### **📂 Event Logs (Journaux d'événements)**
| Emplacement | Description | Commande manuelle |
|-------------|-------------|-------------------|
| **System Event Log** | Événements système | `wevtutil cl System` |
| **Security Event Log** | Événements de sécurité | `wevtutil cl Security` |
| **Application Event Log** | Événements applications | `wevtutil cl Application` |
| **PowerShell Logs** | Historique PowerShell | `wevtutil cl "Windows PowerShell"` |
| **WinRM Logs** | Logs Windows Remote Management | `wevtutil cl "Microsoft-Windows-WinRM/Operational"` |

#### Emplacements physiques des logs
```cmd
# Fichiers de logs Windows
C:\Windows\System32\winevt\Logs\System.evtx
C:\Windows\System32\winevt\Logs\Security.evtx  
C:\Windows\System32\winevt\Logs\Application.evtx
C:\Windows\System32\winevt\Logs\Microsoft-Windows-PowerShell%4Operational.evtx
```

### **📝 Historiques et caches**
| Type | Emplacement | Commande de nettoyage |
|------|-------------|---------------------|
| **Historique CMD** | Registry HKCU | `reg delete HKCU\Software\Microsoft\Command Processor /v AutoRun /f` |
| **Historique PowerShell** | `%APPDATA%\Microsoft\Windows\PowerShell\PSReadline\` | `del %APPDATA%\Microsoft\Windows\PowerShell\PSReadline\*` |
| **Recent Documents** | `%APPDATA%\Microsoft\Windows\Recent\` | `del %APPDATA%\Microsoft\Windows\Recent\*.lnk` |
| **Jump Lists** | `%APPDATA%\Microsoft\Windows\Recent\AutomaticDestinations\` | `del %APPDATA%\Microsoft\Windows\Recent\AutomaticDestinations\*` |
| **Prefetch** | `C:\Windows\Prefetch\` | `del C:\Windows\Prefetch\*.pf` |

### **🌐 Traces réseau et connexions**
| Type | Emplacement | Nettoyage |
|------|-------------|-----------|
| **Cache DNS** | Mémoire système | `ipconfig /flushdns` |
| **Table ARP** | Mémoire système | `arp -d *` |
| **Connexions NetBIOS** | Mémoire système | `nbtstat -R` |
| **Sessions SMB** | Mémoire système | `net use * /delete /y` |

### **🗂️ Fichiers temporaires et logs**
```cmd
# Nettoyage des fichiers temporaires
del %TEMP%\*.* /s /q
del C:\Windows\Temp\*.* /s /q
del %APPDATA%\Local\Temp\*.* /s /q

# Logs IIS (si présent)
del C:\Windows\System32\LogFiles\W3SVC1\*.log

# Logs de sécurité personnalisés
del C:\Windows\Logs\*.log
```

---

## 🛠️ 2. Outils Windows pour automatisation

### **🔧 Outils natifs Windows**

#### **wevtutil - Gestion des Event Logs**
```cmd
# Lister tous les logs disponibles
wevtutil el

# Vider un log spécifique
wevtutil cl System
wevtutil cl Security  
wevtutil cl Application

# Vider tous les principaux logs
for /f %i in ('wevtutil el') do wevtutil cl "%i"

# Exporter avant suppression (forensics)
wevtutil epl System C:\temp\system_backup.evtx
```

#### **sdelete - Suppression sécurisée (Sysinternals)**
```cmd
# Installation (depuis Sysinternals)
# Download: https://docs.microsoft.com/sysinternals/downloads/sdelete

# Suppression sécurisée de fichier
sdelete -p 3 -s -z C:\path\to\file.txt

# Nettoyage espace libre (anti-forensics)  
sdelete -c -z C:

# Options importantes
# -p 3    : 3 passes d'écrasement
# -s      : Récursif dans sous-dossiers
# -z      : Mettre à zéro l'espace libre
# -c      : Nettoyer l'espace libre uniquement
```

#### **cipher - Chiffrement et écrasement**
```cmd
# Écrasement de l'espace libre sur C:
cipher /w:C:\

# Écrasement d'un dossier spécifique
cipher /w:C:\temp\

# Plus rapide que sdelete mais moins de passes
```

### **📜 Scripts PowerShell personnalisés**

#### **Script de nettoyage complet**
```powershell
# ClearTraces.ps1
# Nettoyage automatisé Windows

# Event Logs
Get-WinEvent -ListLog * | ForEach-Object { 
    wevtutil cl $_.LogName 2>$null 
}

# Historiques PowerShell
Remove-Item "$env:APPDATA\Microsoft\Windows\PowerShell\PSReadline\*" -Force -Recurse

# Cache DNS et réseau
ipconfig /flushdns
arp -d *
nbtstat -R

# Fichiers temporaires
Remove-Item "$env:TEMP\*" -Force -Recurse -ErrorAction SilentlyContinue
Remove-Item "C:\Windows\Temp\*" -Force -Recurse -ErrorAction SilentlyContinue

# Recent files
Remove-Item "$env:APPDATA\Microsoft\Windows\Recent\*" -Force

# Prefetch
Remove-Item "C:\Windows\Prefetch\*.pf" -Force

Write-Host "Nettoyage Windows terminé"
```

### **🎯 Outils tiers spécialisés**

#### **CCleaner (ligne de commande)**
```cmd
# Si CCleaner installé
"C:\Program Files\CCleaner\CCleaner.exe" /auto

# Nettoyage personnalisé
"C:\Program Files\CCleaner\CCleaner.exe" /run
```

#### **BleachBit (open source)**
```cmd
# Installation et utilisation
bleachbit -c windows.logs
bleachbit -c system.tmp
bleachbit -c windows.run
```

---

## 🎭 3. Partie Meterpreter Windows

### **📋 Modules Meterpreter de nettoyage**

#### **🧹 clearev - Nettoyage Event Logs**
```bash
# Dans session Meterpreter Windows
meterpreter > clearev

# Explication :
# - Vide les logs System, Security, Application
# - Équivalent à wevtutil cl pour les 3 logs principaux
# - Rapide mais limité aux logs standards
# - Peut laisser des traces dans d'autres logs spécialisés
```

#### **🗑️ timestomp - Manipulation timestamps**
```bash
# Afficher les timestamps actuels d'un fichier
meterpreter > timestomp C:\\file.txt -v

# Modifier tous les timestamps 
meterpreter > timestomp C:\\file.txt -m "01/01/2020 12:00:00"

# Copier les timestamps d'un autre fichier
meterpreter > timestomp C:\\malicious.exe -f C:\\legitimate.exe

# Explication :
# - Modifie Created, Modified, Accessed timestamps
# - Utile pour masquer la création de fichiers
# - Peut aider à éviter la détection temporelle
# - Attention : certains logs gardent des traces
```

### **🔧 Commandes Meterpreter réseau**

#### **Nettoyage des connexions**
```bash
# Session Meterpreter
meterpreter > shell

# Dans le shell Windows
C:\> ipconfig /flushdns
C:\> arp -d *  
C:\> nbtstat -R
C:\> netsh interface ip delete arpcache

# Retour Meterpreter
C:\> exit
```

### **📁 Nettoyage de fichiers via Meterpreter**

#### **Suppression sécurisée**
```bash
# Supprimer des fichiers
meterpreter > rm C:\\temp\\malicious.exe

# Supprimer récursivement
meterpreter > rm -rf C:\\temp\\malware_folder

# Attention : rm basique ne fait pas d'écrasement sécurisé
# Pour écrasement : utiliser shell + sdelete
meterpreter > shell
C:\> sdelete -p 3 -s -z C:\temp\sensitive.txt
C:\> exit
```

### **🎯 Script Meterpreter automatisé**

#### **Resource script de nettoyage**
```bash
# Fichier cleanup.rc
# Usage : msfconsole -r cleanup.rc

clearev
execute -f "cmd.exe" -a "/c ipconfig /flushdns"
execute -f "cmd.exe" -a "/c arp -d *"
execute -f "cmd.exe" -a "/c del %TEMP%\\*.* /s /q"
execute -f "cmd.exe" -a "/c del C:\\Windows\\Temp\\*.* /s /q"
execute -f "powershell.exe" -a "-Command Remove-Item $env:APPDATA\\Microsoft\\Windows\\PowerShell\\PSReadline\\* -Force"
```

---

# 🐧 PARTIE 2 : LINUX

## 🎯 1. Endroits à nettoyer manuellement

### **📋 Log files système**
| Type de Log | Emplacement | Commande de nettoyage |
|-------------|-------------|---------------------|
| **System logs** | `/var/log/messages` | `> /var/log/messages` |
| **Authentication** | `/var/log/auth.log` | `> /var/log/auth.log` |
| **Secure logs** | `/var/log/secure` | `> /var/log/secure` |
| **Kernel logs** | `/var/log/kern.log` | `> /var/log/kern.log` |
| **Syslog** | `/var/log/syslog` | `> /var/log/syslog` |
| **Boot logs** | `/var/log/boot.log` | `> /var/log/boot.log` |

#### **Nettoyage rapide de tous les logs**
```bash
# Vider tous les logs principaux
for log in /var/log/{messages,secure,auth.log,kern.log,syslog,boot.log}; do
    [ -f "$log" ] && > "$log"
done

# Ou avec find
find /var/log -name "*.log" -exec sh -c '> {}' \;
```

### **📝 Historiques utilisateur**
| Type | Emplacement | Nettoyage |
|------|-------------|-----------|
| **Bash history** | `~/.bash_history` | `> ~/.bash_history && history -c` |
| **Zsh history** | `~/.zsh_history` | `> ~/.zsh_history` |
| **MySQL history** | `~/.mysql_history` | `rm ~/.mysql_history` |
| **Python history** | `~/.python_history` | `rm ~/.python_history` |
| **Redis CLI** | `~/.rediscli_history` | `rm ~/.rediscli_history` |
| **Less history** | `~/.lesshst` | `rm ~/.lesshst` |

#### **Nettoyage complet historiques**
```bash
# Script pour tous les utilisateurs
for user_home in /home/*; do
    [ -d "$user_home" ] || continue
    > "$user_home/.bash_history"
    > "$user_home/.zsh_history"  
    rm -f "$user_home"/.{mysql_history,python_history,rediscli_history,lesshst}
done

# Pour root aussi
> /root/.bash_history
rm -f /root/.{mysql_history,python_history,rediscli_history}
```

### **🌐 Logs et caches réseau**
| Type | Emplacement | Commande |
|------|-------------|----------|
| **DHCP logs** | `/var/log/dhcp.log` | `> /var/log/dhcp.log` |
| **Apache logs** | `/var/log/apache2/access.log` | `> /var/log/apache2/access.log` |
| **Nginx logs** | `/var/log/nginx/access.log` | `> /var/log/nginx/access.log` |
| **SSH logs** | `/var/log/auth.log` (inclus) | Déjà couvert |
| **Mail logs** | `/var/log/mail.log` | `> /var/log/mail.log` |

### **🗂️ Fichiers temporaires et caches**
```bash
# Nettoyage des fichiers temporaires
rm -rf /tmp/*
rm -rf /var/tmp/*

# Caches utilisateur
rm -rf /home/*/.cache/*
rm -rf /root/.cache/*

# Thumbnails
rm -rf /home/*/.thumbnails/*
rm -rf /home/*/.local/share/Trash/*

# Recent documents
rm -rf /home/*/.recently-used*
rm -rf /home/*/.local/share/recently-used.xbel
```

---

## 🛠️ 2. Outils Linux pour automatisation

### **🔧 Outils natifs Linux**

#### **logrotate - Gestion automatisée des logs**
```bash
# Configuration personnalisée
cat > /etc/logrotate.d/cleanup << EOF
/var/log/*.log {
    size 1k
    rotate 0
    missingok
    notifempty
    create
}
EOF

# Exécution immédiate
logrotate -f /etc/logrotate.d/cleanup
```

#### **shred - Suppression sécurisée**
```bash
# Suppression sécurisée d'un fichier
shred -vfz -n 3 /path/to/sensitive/file

# Suppression récursive sécurisée
find /tmp -type f -exec shred -vfz -n 3 {} \;

# Options importantes :
# -v : verbose
# -f : force (change permissions si nécessaire)
# -z : écrasement final avec des zéros
# -n 3 : 3 passes d'écrasement
```

#### **wipe - Outil de suppression sécurisée**
```bash
# Installation sur Debian/Ubuntu
apt-get install wipe

# Suppression sécurisée d'un fichier
wipe -rf /path/to/file

# Nettoyage d'un répertoire complet
wipe -rf /tmp/sensitive_folder/

# Options :
# -r : récursif
# -f : force
# -q : mode silencieux
```

### **📜 Scripts de nettoyage personnalisés**

#### **Script bash complet**
```bash
#!/bin/bash
# linux_cleanup.sh - Nettoyage complet Linux

echo "[+] Nettoyage des logs système..."
for log in /var/log/{messages,secure,auth.log,kern.log,syslog,boot.log,mail.log}; do
    [ -f "$log" ] && > "$log" && echo "Vidé: $log"
done

echo "[+] Nettoyage des historiques utilisateur..."  
for user_home in /home/* /root; do
    [ -d "$user_home" ] || continue
    > "$user_home/.bash_history"
    > "$user_home/.zsh_history"
    rm -f "$user_home"/.{mysql_history,python_history,rediscli_history,lesshst}
    echo "Nettoyé: $user_home"
done

echo "[+] Vider l'historique de la session courante..."
history -c

echo "[+] Nettoyage fichiers temporaires..."
rm -rf /tmp/* /var/tmp/*

echo "[+] Nettoyage caches utilisateur..."
rm -rf /home/*/.cache/* /root/.cache/*

echo "[+] Logs web servers..."
> /var/log/apache2/access.log 2>/dev/null
> /var/log/apache2/error.log 2>/dev/null  
> /var/log/nginx/access.log 2>/dev/null
> /var/log/nginx/error.log 2>/dev/null

echo "[+] Nettoyage terminé!"
```

### **🎯 Outils spécialisés tiers**

#### **BleachBit pour Linux**
```bash
# Installation
apt-get install bleachbit

# Utilisation ligne de commande
bleachbit -c system.tmp
bleachbit -c bash.history
bleachbit -c system.logs

# Nettoyage complet automatisé
bleachbit -c bash.history system.cache system.logs system.tmp
```

#### **rmlogs - Script spécialisé**
```bash
# Script personnalisé pour logs
#!/bin/bash
# rmlogs.sh

LOGS="/var/log/{auth,boot,btmp,daemon,debug,dmesg,kern,mail,messages,syslog,user,wtmp,lastlog}.log"
for i in $LOGS; do
    [ -f $i ] && cat /dev/null > $i
done
```

---

## 🎭 3. Partie Meterpreter Linux

### **📋 Modules Meterpreter Linux**

#### **🧹 clearev - Nettoyage Event Logs Linux**
```bash
# Dans session Meterpreter Linux
meterpreter > clearev

# Explication spécifique Linux :
# - Vide /var/log/auth.log, /var/log/syslog, /var/log/messages
# - Plus limité que la version Windows
# - Peut ne pas couvrir tous les logs spécialisés
# - Efficace pour les logs d'authentification SSH
```

#### **🗑️ timestomp - Timestamps Linux**
```bash
# Afficher les timestamps
meterpreter > timestomp /tmp/file.txt -v

# Modifier les timestamps  
meterpreter > timestomp /tmp/file.txt -m "01/01/2020 12:00:00"

# Copier depuis un autre fichier
meterpreter > timestomp /tmp/backdoor -f /bin/ls

# Explication Linux :
# - Modifie atime, mtime, ctime
# - Plus complexe sous Linux (ctime automatique)
# - Utile pour masquer la création de backdoors
# - Attention aux inodes et extended attributes
```

### **🔧 Nettoyage via shell Meterpreter**

#### **Nettoyage des logs système**
```bash
# Session Meterpreter Linux
meterpreter > shell

# Dans le shell Linux
$ > /var/log/auth.log
$ > /var/log/syslog  
$ > /var/log/messages
$ > /var/log/secure

# Historique utilisateur courant
$ > ~/.bash_history
$ history -c

# Retour Meterpreter
$ exit
```

#### **Nettoyage avancé via shell**
```bash
meterpreter > shell

# Script one-liner complet
$ for log in /var/log/{auth,syslog,messages,secure,mail,kern}.log; do [ -f $log ] && > $log; done; > ~/.bash_history; history -c

# Nettoyage fichiers temporaires
$ rm -rf /tmp/* /var/tmp/*

# Nettoyage traces réseau (si root)
$ > /var/log/wtmp
$ > /var/log/btmp  
$ > /var/log/lastlog

$ exit
```

### **📁 Suppression sécurisée via Meterpreter**

#### **Commandes de suppression**
```bash
# Suppression basique
meterpreter > rm /tmp/malicious_script.sh

# Suppression récursive
meterpreter > rm -rf /tmp/malware_folder

# Pour suppression sécurisée, utiliser shell + shred
meterpreter > shell
$ shred -vfz -n 3 /tmp/sensitive_file
$ exit
```

### **🎯 Resource script Meterpreter Linux**

#### **Script automatisé linux_cleanup.rc**
```bash
# Fichier linux_cleanup.rc
# Usage : msfconsole -r linux_cleanup.rc

clearev
execute -f "/bin/sh" -a "-c 'for log in /var/log/{auth,syslog,messages}.log; do > $log 2>/dev/null; done'"
execute -f "/bin/sh" -a "-c '> ~/.bash_history; history -c'"
execute -f "/bin/sh" -a "-c 'rm -rf /tmp/* /var/tmp/* 2>/dev/null'"
execute -f "/bin/sh" -a "-c 'find /home -name \".bash_history\" -exec sh -c \"> {}\" \\;'"
```

---

## ⚠️ Points d'attention et bonnes pratiques

### **🛡️ Précautions générales**
- **Toujours sauvegarder** avant suppression (sauf en situation hostile)
- **Tester les scripts** sur un environnement de lab d'abord
- **Vérifier les permissions** requises pour chaque action
- **Attention aux services actifs** qui peuvent recréer les logs

### **🎯 Ordre de priorité eJPT**
1. **Event Logs** - Traces d'authentification et système
2. **Historiques shell** - Commandes exécutées
3. **Fichiers temporaires** - Outils uploadés
4. **Timestamps** - Masquer la création de fichiers
5. **Logs réseau** - Connexions et transferts

### **📊 Efficacité des méthodes**

| Méthode | Windows | Linux | Furtivité | Rapidité |
|---------|---------|-------|-----------|----------|
| **clearev** | 🟢 Excellent | 🟡 Partiel | 🟢 Haute | 🟢 Rapide |
| **Nettoyage manuel** | 🟢 Complet | 🟢 Complet | 🟡 Moyenne | 🔴 Lent |
| **Scripts auto** | 🟢 Très bon | 🟢 Très bon | 🟢 Haute | 🟢 Rapide |
| **Outils tiers** | 🟡 Variable | 🟡 Variable | 🔴 Faible | 🟢 Rapide |

### **🚨 Erreurs à éviter**
- Ne pas supprimer des logs critiques pour la stabilité système
- Oublier de vider l'historique de la session courante
- Utiliser des outils qui laissent leurs propres traces
- Ne pas vérifier les sauvegardes automatiques de logs
- Ignorer les logs d'applications spécifiques installées